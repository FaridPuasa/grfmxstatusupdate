<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Jobs</title>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">

<!-- SweetAlert2 -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

<style>
  /* Custom CSS for your page */
        .navbar-nav.flex-row {
            flex-direction: row !important;
        }

        /* Make the navbar background transparent */
        .navbar {
            background-color: transparent;
        }

        /* Add background color to the container */
        .container-bg {
            background-color: #333;
            /* You can use your desired background color here */
        }

        /* Add margin to the navigation links */
        .navbar-nav.flex-row .nav-item {
            margin-right: 10px;
        }
th, td { text-align: center; font-size: 14px; }
.filters-container { background-color: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
table.dataTable { width: 100% !important; }
.form-label { font-weight: 600; }
/* Loading overlay */
#loadingOverlay {
  display: none; /* start hidden */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.7);
  z-index: 1050;

  /* Center spinner */
  display: flex;           /* use flex */
  justify-content: center; /* horizontal center */
  align-items: center;     /* vertical center */
}

.filter-applied {
  background-color: #d1ecf1 !important;
}

.logo {
  height: 40px;
  width: auto;
  max-height: 40px;
}

@media (max-width: 768px) {
  .logo {
    height: 30px;
    max-height: 30px;
  }
}

@media (max-width: 480px) {
  .logo {
    height: 25px;
    max-height: 25px;
  }
}
</style>
</head>
<body>

  <div class="container-bg">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container d-flex align-items-center">

    <!-- Logo: left on mobile, center on desktop -->
    <a class="navbar-brand d-lg-none" href="/">
      <img src="/images/logoportalwhite.png" alt="Go Rush Logo" class="logo img-fluid">
    </a>

    <!-- Burger menu button -->
    <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarResponsive"
            aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsible menu -->
    <div class="collapse navbar-collapse w-100" id="navbarResponsive">

      <!-- Desktop left menus -->
      <ul class="navbar-nav d-none d-lg-flex">
        <% if (['finance','warehouse','cs','dispatcher','manager','admin'].includes(user.role)) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="desktopOperationDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Operation</a>
            <div class="dropdown-menu" aria-labelledby="allOrdersDropdown">
                            <% if (['finance', 'warehouse', 'cs' , 'dispatcher' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="/updateDelivery">Update Delivery</a>
                            <% } %>
                            <% if (['warehouse', 'dispatcher' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="https://warehouse.gorushbn.com">Scan Parcel In Warehouse</a>
                            <% } %>
                            <% if (['cs' , 'warehouse' , 'manager' , 'admin'].includes(user.role)) { %>
                                <a class="dropdown-item" href="/podGenerator">POD Generator</a>
                            <% } %>
                            <% if (['finance', 'warehouse', 'cs' , 'dispatcher' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="/addressAreaCheck">Address Area Checker</a>
                                <a class="dropdown-item" href="/searchJobs">Search Jobs</a>
                            <% } %>
                            <% if (['cs' , 'warehouse' , 'manager' , 'admin'].includes(user.role)) { %>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-header">POD</div>
                                <a class="dropdown-item" href="/listofpharmacyPod">Pharmacy</a>
                                <a class="dropdown-item" href="/listofnoncodPod">EWE/PDU/MGLOBAL</a>
                                <a class="dropdown-item" href="/listofldPod">LD/Pure51/KPT/ICARUS</a>
                                <a class="dropdown-item" href="/listofcbslPod">Cross Border Service (Limbang)</a>
                            <% } %>
                        </div>
          </li>
        <% } %>
        <% if (['moh','cs','manager','admin','warehouse'].includes(user.role)) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="desktopMohDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">MOH</a>
            <div class="dropdown-menu" aria-labelledby="mohDropdown">
                            <% if (['moh'].includes(user.role)) { %>
                                <a class="dropdown-item" href="/mohsearch">Search</a>
                            <% } %>
                            <% if (['warehouse', 'cs' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="https://pharmacy.gorushbn.com/mohorders?">Create Pharmacy Form</a>
                            <% } %>
                            <% if (['cs', 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="https://pharmacy.gorushbn.com/manifestviewer">Pharmacy Form List</a>
                                <a class="dropdown-item" href="/listofWargaEmasOrders">All Warga Emas Orders</a>
                            <% } %>
                        </div>
          </li>
        <% } %>
      </ul>

      <!-- Center logo for desktop -->
      <a class="navbar-brand mx-auto d-none d-lg-flex" href="/">
        <img src="/images/logoportalwhite.png" alt="Go Rush Logo" class="logo img-fluid">
      </a>

      <!-- Desktop right menus -->
      <ul class="navbar-nav ms-auto d-none d-lg-flex">
        <% if (user) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="desktopAccountDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <%= user.name %> (<%= user.role.toUpperCase() %>)
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="desktopAccountDropdown">
              <a class="dropdown-item" href="/">Dashboard</a>
              <% if (['admin'].includes(user.role)) { %>
                <a class="dropdown-item" href="/createUser">Create User</a>
              <% } %>
              <a class="dropdown-item" href="/logout">Logout</a>
            </div>
          </li>
        <% } else { %>
          <li class="nav-item">
            <a class="nav-link" href="/login">Login</a>
          </li>
        <% } %>
      </ul>

      <!-- Mobile menus (visible when burger expands) -->
      <ul class="navbar-nav d-lg-none mt-2">
        <% if (['finance','warehouse','cs','dispatcher','manager','admin'].includes(user.role)) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="mobileOperationDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Operation</a>
            <div class="dropdown-menu" aria-labelledby="allOrdersDropdown">
                            <% if (['finance', 'warehouse', 'cs' , 'dispatcher' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="/updateDelivery">Update Delivery</a>
                            <% } %>
                            <% if (['warehouse', 'dispatcher' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="https://warehouse.gorushbn.com">Scan Parcel In Warehouse</a>
                            <% } %>
                            <% if (['cs' , 'warehouse' , 'manager' , 'admin'].includes(user.role)) { %>
                                <a class="dropdown-item" href="/podGenerator">POD Generator</a>
                            <% } %>
                            <% if (['finance', 'warehouse', 'cs' , 'dispatcher' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="/addressAreaCheck">Address Area Checker</a>
                                <a class="dropdown-item" href="/searchJobs">Search Jobs</a>
                            <% } %>
                            <% if (['cs' , 'warehouse' , 'manager' , 'admin'].includes(user.role)) { %>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-header">POD</div>
                                <a class="dropdown-item" href="/listofpharmacyPod">Pharmacy</a>
                                <a class="dropdown-item" href="/listofnoncodPod">EWE/PDU/MGLOBAL</a>
                                <a class="dropdown-item" href="/listofldPod">LD/Pure51/KPT/ICARUS</a>
                                <a class="dropdown-item" href="/listofcbslPod">Cross Border Service (Limbang)</a>
                            <% } %>
                        </div>
          </li>
        <% } %>
        <% if (['moh','cs','manager','admin','warehouse'].includes(user.role)) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="mobileMohDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">MOH</a>
            <div class="dropdown-menu" aria-labelledby="mohDropdown">
                            <% if (['moh'].includes(user.role)) { %>
                                <a class="dropdown-item" href="/mohsearch">Search</a>
                            <% } %>
                            <% if (['warehouse', 'cs' , 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="https://pharmacy.gorushbn.com/mohorders?">Create Pharmacy Form</a>
                            <% } %>
                            <% if (['cs', 'manager' , 'admin' ].includes(user.role)) { %>
                                <a class="dropdown-item" href="https://pharmacy.gorushbn.com/manifestviewer">Pharmacy Form List</a>
                                <a class="dropdown-item" href="/listofWargaEmasOrders">All Warga Emas Orders</a>
                            <% } %>
                        </div>
          </li>
        <% } %>
        <% if (user) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="mobileAccountDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <%= user.name %> (<%= user.role.toUpperCase() %>)
            </a>
            <div class="dropdown-menu" aria-labelledby="mobileAccountDropdown">
              <a class="dropdown-item" href="/">Dashboard</a>
              <% if (['admin'].includes(user.role)) { %>
                <a class="dropdown-item" href="/createUser">Create User</a>
              <% } %>
              <a class="dropdown-item" href="/logout">Logout</a>
            </div>
          </li>
        <% } else { %>
          <li class="nav-item">
            <a class="nav-link" href="/login">Login</a>
          </li>
        <% } %>
      </ul>

    </div>
  </div>
</nav>
    </div>
</div>
<h1 class="text-center mt-4">Search Jobs</h1>
<div class="container filters-container">
  
  <form id="searchForm">
    <!-- Row 1: Text fields -->
        <div class="row mb-2">
      <div class="col-md-3">
        <label class="form-label">Go Rush Tracking No.</label>
        <textarea class="form-control" name="doTrackingNumber" rows="3"></textarea>
      </div>
      <div class="col-md-3">
        <label class="form-label">Original Tracking No.</label>
        <textarea class="form-control" name="parcelTrackingNum" rows="3"></textarea>
      </div>
      <div class="col-md-3">
        <label class="form-label">Customer Name</label>
        <input type="text" class="form-control" name="receiverName">
      </div>
      <div class="col-md-3">
        <label class="form-label">Customer Address</label>
        <input type="text" class="form-control" name="receiverAddress">
      </div>
    </div>
    <!-- Row 2: Date filters -->
    <div class="row mb-2">
      <div class="col-md-3">
        <label class="form-label">Job Date From</label>
        <input type="date" class="form-control" name="jobDateFrom">
      </div>
      <div class="col-md-3">
        <label class="form-label">Job Date To</label>
        <input type="date" class="form-control" name="jobDateTo">
      </div>
      <div class="col-md-3">
        <label class="form-label">Job Created Date From</label>
        <input type="date" class="form-control" name="creationDateFrom">
      </div>
      <div class="col-md-3">
        <label class="form-label">Job Created Date To</label>
        <input type="date" class="form-control" name="creationDateTo">
      </div>
    </div>
    <!-- Row 3: Dropdowns -->
    <div class="row mb-2">
      <div class="col-md-3">
        <label class="form-label">Job Method</label>
        <select class="form-control select2" name="jobMethod[]" multiple>
          <option value="Standard">Standard</option>
          <option value="Express">Express</option>
          <option value="Immediate">Immediate</option>
          <option value="Drop Off">Drop Off</option>
          <option value="Self Collect">Self Collect</option>
          <option value="Pickup">Pickup</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Product</label>
        <select class="form-control select2" name="product[]" multiple>
          <option value="pharmacymoh">Pharmacy MOH</option>
          <option value="pharmacyjpmc">Pharmacy JPMC</option>
          <option value="pharmacyphc">Pharmacy PHC</option>
          <option value="localdelivery">Local Delivery</option>
          <option value="cbsl">Cross Border Service Limbang</option>
          <option value="ewe">EWE</option>
          <option value="mglobal">MGLOBAL</option>
          <option value="pdu">PDU</option>
          <option value="kptdp">KPT</option>
          <option value="pure51">Pure51</option>
          <option value="icarus">ICARUS</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Assigned To</label>
        <select class="form-control select2" name="assignedTo[]" multiple>
          <option value="Ghafar">Ghafar</option>
          <option value="Leo">Leo</option>
          <option value="Sowdeq">Sowdeq</option>
          <option value="Wafi">Wafi</option>
          <option value="Zakwan">Zakwan</option>
          <option value="FL1">FL1</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Area</label>
        <select class="form-control select2" name="area[]" multiple>
          <option value="B">B</option>
          <option value="G">G</option>
          <option value="JT">JT</option>
          <option value="TUTONG">TUTONG</option>
          <option value="KB">KB</option>
          <option value="LUMUT">LUMUT</option>
          <option value="SERIA">SERIA</option>
          <option value="TEMBURONG">TEMBURONG</option>
        </select>
      </div>
    </div>

    <!-- Row 4: More dropdowns -->
    <div class="row mb-2">
      <div class="col-md-3">
        <label class="form-label">Job Status</label>
        <select class="form-control select2" name="currentStatus[]" multiple>
          <option value="Info Received">Info Received</option>
          <option value="At Warehouse">At Warehouse</option>
          <option value="Out for Delivery">Out for Delivery</option>
          <option value="Completed">Completed</option>
          <option value="Return to Warehouse">Return to Warehouse</option>
          <option value="Cancelled">Cancelled</option>
          <option value="Disposed">Disposed</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Reason</label>
        <select class="form-control select2" name="latestReason[]" multiple>
          <option value="Unattempted Delivery">Unattempted Delivery</option>
          <option value="Reschedule delivery requested by customer">Reschedule delivery requested by customer</option>
          <option value="Reschedule to self collect requested by customer">Reschedule to self collect requested by customer</option>
          <option value="Cash/Duty Not Ready">Cash/Duty Not Ready</option>
          <option value="Customer not available / cannot be contacted">Customer not available / cannot be contacted</option>
          <option value="No Such Person">No Such Person</option>
          <option value="Customer declined delivery">Customer declined delivery</option>
          <option value="Unable to Locate Address">Unable to Locate Address</option>
          <option value="Incorrect Address">Incorrect Address</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Latest Location</label>
        <select class="form-control select2" name="latestLocation[]" multiple>
          <option value="Warehouse K1">Warehouse K1</option>
          <option value="Warehouse K2">Warehouse K2</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Payment Method</label>
        <select class="form-control select2" name="paymentMethod[]" multiple>
          <option value="Bank Transfer (Baiduri)">Bank Transfer (Baiduri)</option>
          <option value="Bank Transfer (BIBD)">Bank Transfer (BIBD)</option>
          <option value="Bill Payment (BIBD)">Bill Payment (BIBD)</option>
          <option value="Cash">Cash</option>
          <option value="NON COD">NON COD</option>
        </select>
      </div>
    </div>

    <!-- Row 5: Text fields -->
    <div class="row mb-2">
      <div class="col-md-3">
        <label class="form-label">MAWB No.</label>
        <input type="text" class="form-control" name="mawbNo">
      </div>
      <div class="col-md-3">
        <label class="form-label">Postal Code</label>
        <input type="text" class="form-control" name="receiverPostalCode">
      </div>
      <div class="col-md-3">
        <label class="form-label">Main Phone No.</label>
        <input type="text" class="form-control" name="receiverPhoneNumber">
      </div>
      <div class="col-md-3">
        <label class="form-label">Additional Phone No.</label>
        <input type="text" class="form-control" name="additionalPhoneNumber">
      </div>
    </div>

    <!-- Row 6: IC/Passport and Patient No. -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">IC/Passport No.</label>
        <input type="text" class="form-control" name="icPassNum">
      </div>
      <div class="col-md-6">
        <label class="form-label">Patient No.</label>
        <input type="text" class="form-control" name="patientNumber">
      </div>
    </div>

    <!-- Row 7: Buttons -->
    <div class="row mb-3">
      <div class="col-md-6">
        <button type="submit" class="btn btn-primary w-100">Search</button>
      </div>
      <div class="col-md-6">
        <button type="button" id="resetFilters" class="btn btn-secondary w-100">Reset</button>
      </div>
    </div>
  </form>
</div>

<!-- Table Header -->
  <h5 id="tableHeader" class="text-center mb-2"></h5>

<div class="container-fluid px-0">
  <table id="jobsTable" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>S/N</th>
        <th>Action</th>
        <th>Go Rush Remark</th>
        <th>Customer Remark</th>
        <th>Go Rush Tracking No.</th>
        <th>Product</th>
        <th>Job Status</th>
        <th>Latest Location</th>
        <th>Age (Days)</th>
        <th>Job Method</th>
        <th>Job Date</th>
        <th>Assigned To</th>
        <th>Attempt</th>
        <th>Payment Method</th>
        <th>Payment Amount</th>
        <th>Name</th>
        <th>Main Phone No.</th>
        <th>Additional Phone No.</th>
        <th>Customer Address</th>
        <th>Postal Code</th>
        <th>Area</th>
        <th>Job Created Date</th>
        <th>MAWB No.</th>
        <th>IC/Passport No.</th>
        <th>Patient No.</th>
        <th>Item Description</th>
        <th>Quantity</th>
        <th>Invoice/Item Screenshot</th>
        <th>Original Tracking No.</th>
        <th>Item Original Price</th>
        <th>Weight (KG)</th>
        <th>No. of Packages</th>
        <th>Handling Charge</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Reorder Modal -->
<div class="modal fade" id="reorderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="reorderForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reorder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="trackingNumber" name="trackingNumber">
        <div class="mb-3">
          <label>Job Method</label>
          <select class="form-control" id="jobMethod" name="jobMethod" required></select>
        </div>
        <div class="mb-3">
          <label>Payment Method</label>
          <select class="form-control" id="paymentMethod" name="paymentMethod" required>
            <option value="Cash">Cash</option>
            <option value="Bank Transfer (Baiduri)">Bank Transfer (Baiduri)</option>
            <option value="Bank Transfer (BIBD)">Bank Transfer (BIBD)</option>
            <option value="Bill Payment (BIBD)">Bill Payment (BIBD)</option>
          </select>
        </div>
        <div class="mb-3">
          <label>Remarks</label>
          <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary w-100">Confirm Reorder</button>
      </div>
    </form>
  </div>
</div>

<div id="loadingOverlay" style="display:none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden"></span>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<script>
$(document).ready(function() {
  // Initialize Select2
  $('.select2').select2({ width: '100%' });

  let manifestView = false; // Toggle state for Manifest to Bill view

  // Initialize DataTable
  let table = $('#jobsTable').DataTable({
    dom: 'lBfrtip',
    buttons: [
      {
  extend: 'excelHtml5',
  text: 'Export Excel',
  exportOptions: {
    columns: ':visible',
    orthogonal: 'export',
    format: {
      body: function (data, row, column, node) {
        if (column === 0) return row + 1; // S/N column
        return data;
      }
    }
  },
  filename: function() {
    // Build the filter part of the filename
    let filters = [];
    $('#searchForm').find('input[type="text"], textarea').each(function() {
      const val = $(this).val().trim();
      if (val) filters.push(val.replace(/[\s\/\\:*?"<>|]/g, '_'));
    });
    $('#searchForm').find('select.select2').each(function() {
      const val = $(this).val();
      if (val && val.length) filters.push(val.join('-').replace(/[\s\/\\:*?"<>|]/g, '_'));
    });
    const filterText = filters.length ? filters.join('_') : 'SearchJob';

    // Get today's date
    const today = moment().format('DD.MM.YYYY');

    // Get number of rows currently displayed in the table
    const rowCount = table.rows({ filter: 'applied' }).data().length;

    return `${filterText}_${today}(${rowCount})`;
  }
},
      {
        extend: 'colvis',
        text: 'Show/Hide Columns'
      },
      <% if (['finance', 'manager', 'admin'].includes(user.role)) { %>
      {
        text: 'Manifest to Bill',
        action: function(e, dt, node, config) {
          const manifestCols = [
            0,  // S/N
            4,  // Go Rush Tracking No.
            15, // Name
            16, // Main Phone No.
            17, // Customer Address
            19, // Postal Code
            30, // Weight (KG)
            31, // No. of Packages
            32  // Handling Charge
          ];

          if (!manifestView) {
            // Hide all other columns
            dt.columns().every(function(index) {
              if (!manifestCols.includes(index)) this.visible(false);
            });
          } else {
            // Show all columns
            dt.columns().visible(true);
          }

          manifestView = !manifestView;
        }
      }
      <% } %>
    ],
    pageLength: 25,
    lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
    ordering: true,
    order: [[1, 'desc']], // Default ordering
    columns: [
      {
        data: null,
        orderable: false,
        className: 'no-export',
        render: function(data, type, row, meta) {
          return meta.row + 1; // Fixed S/N
        }
      },
      { 
        data: null, 
        orderable: false, 
        className: 'no-export',
        render: function(data, type, row) {
          if (['pharmacymoh','pharmacyjpmc','pharmacyphc'].includes(row.product.toLowerCase())) {
            return `<button class="btn btn-sm btn-primary reorder-btn" 
                      data-tracking="${row.doTrackingNumber}" 
                      data-address="${row.receiverAddress}" 
                      data-product="${row.product}">Reorder</button>`;
          }
          return '';
        }
      },
      { data: 'grRemark' },
      { data: 'remarks' },
      { data: 'doTrackingNumber' },
      { data: 'product' },
      { data: 'currentStatus' },
      { data: 'latestLocation' },
      { data: 'age' },
      { data: 'jobMethod' },
      { data: 'jobDate' },
      { data: 'assignedTo' },
      { data: 'attempt' },
      { data: 'paymentMethod' },
      { data: 'paymentAmount' },
      { data: 'receiverName' },
      { data: 'receiverPhoneNumber' },
      { data: 'additionalPhoneNumber' },
      { data: 'receiverAddress' },
      { data: 'receiverPostalCode' },
      { data: 'area' },
      { data: 'creationDate' },
      { data: 'mawbNo' },
      { data: 'icPassNum' },
      { data: 'patientNumber' },
      { data: 'itemsDescription' },
      { data: 'itemsQuantity' },
      { data: 'screenshotInvoice',
        render: function (data, type, row) {
          if (type === 'export' || type === 'excel') return data || '';
          if (!data) return '';
          return '<a href="' + data + '" target="_blank">View Invoice</a>';
        }
      },
      { data: 'parcelTrackingNum' },
      { data: 'cargoPrice' },
      { data: 'parcelWeight' },
      { data: 'noOfpackages' },
      <% if (['finance', 'manager', 'admin'].includes(user.role)) { %>
{ data: 'handlingCharge' }
<% } else { %>
{ data: 'handlingCharge', visible: false }
<% } %>
    ]
  });

  // Reset Filters
  $('#resetFilters').on('click', function() {
    $('#searchForm')[0].reset();
    $('.select2').val(null).trigger('change');
    $('#searchForm').find('input, textarea, select').removeClass('filter-applied');
    $('#tableHeader').text('');
  });

  // Handle search form submission
  $('#searchForm').on('submit', function(e) {
    e.preventDefault();
    const filters = {};

    $('#loadingOverlay').show();

    $(this).find('input[type="text"], input[type="date"], textarea').each(function() {
      const val = $(this).val();
      if (val) { filters[$(this).attr('name')] = val; $(this).addClass('filter-applied'); }
      else { $(this).removeClass('filter-applied'); }
    });

    $(this).find('select.select2').each(function() {
      const name = $(this).attr('name').replace('[]','');
      const val = $(this).val();
      if (val && val.length) { filters[name] = val; $(this).addClass('filter-applied'); }
      else { $(this).removeClass('filter-applied'); }
    });

    $.ajax({
      url: '/searchJobs',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(filters),
      success: function(data) {
        table.clear().rows.add(data).draw();

        // Build header with applied filters and row count
        let filterNames = [];
        $('#searchForm').find('input[type="text"], textarea').each(function() {
          const val = $(this).val().trim();
          if (val) filterNames.push(val);
        });
        $('#searchForm').find('select.select2').each(function() {
          const val = $(this).val();
          if (val && val.length) filterNames.push(val.join(', '));
        });
        const filterText = filterNames.length ? filterNames.join(' | ') : 'All Jobs';
        const rowCount = data.length;
        $('#tableHeader').text(`${filterText} (${rowCount})`);
      },
      error: function() {
        alert('Error fetching jobs');
      },
      complete: function() { $('#loadingOverlay').hide(); }
    });
  });

  table.on('draw', function() {
    $('#loadingOverlay').hide();
  });

  // Reorder button click
  $(document).on('click', '.reorder-btn', function() {
    const trackingNumber = $(this).data('tracking');
    const address = $(this).data('address').toLowerCase();
    const product = $(this).data('product').toLowerCase();

    const jobMethodSelect = $('#jobMethod');
    jobMethodSelect.empty();

    const currentDay = moment().day();
    const currentTime = moment().hour();

    function isExpressAvailable() {
      if (currentDay === 4 && currentTime >= 11) return false; 
      if (currentDay === 5 || currentDay === 6) return false;
      return true;
    }
    function isImmediateAvailable() {
      if (currentDay === 0 || currentDay === 5) return false;
      return currentTime >= 8 && currentTime <= 15;
    }

    if (product === 'pharmacymoh' || product === 'pharmacyjpmc') {
      if (address.includes('brunei muara') || address.includes('brunei-muara')) {
        jobMethodSelect.append('<option value="Standard">Standard</option>');
        if (isExpressAvailable()) jobMethodSelect.append('<option value="Express">Express</option>');
        if (isImmediateAvailable()) jobMethodSelect.append('<option value="Immediate">Immediate</option>');
        jobMethodSelect.append('<option value="Self Collect">Self Collect</option>');
      } else {
        jobMethodSelect.append('<option value="Standard">Standard</option>');
        jobMethodSelect.append('<option value="Self Collect">Self Collect</option>');
      }
    } else if (product === 'pharmacyphc') {
      jobMethodSelect.append('<option value="Standard">Standard</option>');
      jobMethodSelect.append('<option value="Self Collect">Self Collect</option>');
    }

    $('#trackingNumber').val(trackingNumber);
    $('#reorderModal').modal('show');
  });

  $('#reorderForm').on('submit', async function(e) {
    e.preventDefault();
    const trackingNumber = $('#trackingNumber').val();
    const jobMethod = $('#jobMethod').val();
    const paymentMethod = $('#paymentMethod').val();
    const remarks = $('#remarks').val();

    try {
      const response = await fetch('/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackingNumber, jobMethod, paymentMethod, remarks })
      });
      const result = await response.json();
      if (result.success) alert('Order is submitted');
      else alert('Order submission failed: ' + result.message);
      $('#reorderModal').modal('hide');
    } catch(err) {
      console.error(err);
      alert('Error submitting reorder');
    }
  });
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>