<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Job</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <script src="https://unpkg.com/imask"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .result-section {
            display: none;
            margin-top: 20px;
        }

        .table-responsive {
            margin-bottom: 30px;
        }

        .scan-section {
            display: none;
        }

        .scan-active {
            background-color: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 5px;
            padding: 15px;
        }
    </style>
</head>

<body>
    <div class="container-bg">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <%- include('partials/navbar') %>
                </div>
            </div>
        </div>
    </div>
    <div class="container mt-4">
        <!-- Initial Header and Form Section -->
        <div id="initialSection">
            <h1 class="mb-4">Update Job</h1>

            <form id="updateJobForm">
                <div class="mb-3">
                    <label for="updateCode" class="form-label">Tracking Status Code / Detail to be updated:</label>
                    <select id="updateCode" name="updateCode" class="form-select" required>
                        <option value="" selected>Please select status</option>
                        <optgroup label="EWE/MGLOBAL/PDU/GDEX Flow">
                            <option value="UAN">1. MAWB Number</option>
                            <option value="CCH">2. On Hold</option>
                        </optgroup>
                        <!-- Other optgroups remain the same -->
                        <optgroup label="Standard Flow">
                            <option value="IIW">1. Item in Warehouse</option>
                            <!-- <option value="OFD">2.1. Out for Delivery</option>
                            <option value="OSC">2.2. Self Collect</option> -->
                        </optgroup>
                        <!-- <optgroup label="MGLOBAL Flow">
                            <option value="FCC">1.1. Fail due to Customer not available / cannot be contacted</option>
                            <option value="FIA">1.2. Fail due to Incorrect Address</option>
                            <option value="FSC">1.3.1. Fail due to Reschedule to self collect requested by customer
                            </option>
                            <option value="OSC">1.3.2. Self Collect</option>
                        </optgroup>
                        <optgroup label="After Success/Fail updated on Agent App">
                            <option value="SFJ">Clear Job</option>
                        </optgroup> -->
                        <optgroup label="Change Details">
                            <!-- <option value="OSD">Swap Dispatchers</option>
                            <option value="UWL">Update Warehouse</option>
                            <option value="UGR">Update Go Rush Remark</option>
                            <option value="UJD">Update Job Date</option>
                            <option value="UJM">Update Job Method</option>
                            <option value="UJP">Update Price</option>
                            <option value="UAW">Update Weight</option>
                            <option value="UAS">Update Address</option>
                            <option value="UAR">Update Area</option>
                            <option value="UPN">Update Phone Number</option>
                            <option value="URN">Update Customer Name</option>
                            <option value="UPC">Update Postal Code</option> -->
                            <option value="UMN">Update MAWB Number</option>
                        </optgroup>
                        <!-- <optgroup label="Danger Zone!!!">
                            <option value="UCD">1. Cancelled Job</option>
                            <option value="URJ">2. Cancelled -> Reactivate Job</option>
                            <option value="UDJ">3. Dispose Job</option>
                        </optgroup> -->
                    </select>
                </div>

                <div id="mawbFields" style="display: none;">
                    <!-- MAWB Number Field -->
                    <div id="mawbNumContainer">
                        <div class="mb-3">
                            <label for="mawbNum" class="form-label">MAWB No:
                                <span id="mawbRequired" class="text-danger">*</span>
                                <span id="mawbOptional" class="text-muted" style="display:none;"> (Optional)</span>
                            </label>
                            <select id="mawbNum" name="mawbNum" class="form-select" style="display: none;">
                                <option value="" selected>Please select MAWB Number (optional)</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <input type="text" id="mawbNumInput" name="mawbNumInput" class="form-control"
                                style="display: none;">
                            <div class="form-text" id="mawbHelp">Select MAWB number for bulk scanning or leave empty for
                                individual updates</div>
                            <div id="mawbStats" class="mt-2" style="display: none;">
                                <small class="text-muted" id="mawbStatsText"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Warehouse Field -->
                    <div id="warehouseFields" style="display: none;">
                        <div class="mb-3">
                            <label for="warehouse" class="form-label">Warehouse:</label>
                            <select id="warehouse" name="warehouse" class="form-select" required>
                                <option value="" selected>Please select warehouse location</option>
                                <option value="Warehouse K1">Warehouse K1</option>
                                <option value="Warehouse K2">Warehouse K2</option>
                            </select>
                            <div class="warehouse-notes">
                                <small>K1 &gt; Go Rush Kiulap</small><br>
                                <small>K2 &gt; Simpang 14-9</small><br>
                                <strong><small>*If no failed job, pick K1</small></strong>
                            </div>
                        </div>
                    </div>

                    <!-- Update Method -->
                    <div class="mb-3">
                        <label for="updateMethod" class="form-label">Update Method:</label>
                        <select id="updateMethod" name="updateMethod" class="form-select" required>
                            <option value="" selected>Please select method</option>
                            <option value="bulk">1. Bulk</option>
                            <option value="onebyone">2. One by one</option>
                        </select>
                    </div>

                    <!-- Bulk Section -->
                    <div id="bulkSection" class="update-section" style="display: none;">
                        <div class="mb-3">
                            <label for="trackingNumBulk" class="form-label">Tracking Number(s):</label>
                            <textarea id="trackingNumBulk" name="trackingNumBulk" class="form-control" rows="2"
                                placeholder="Enter one tracking number per line"></textarea>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button type="submit" id="submitButton" class="btn btn-primary me-md-2">Submit</button>
                        </div>
                    </div>

                    <!-- One by One Section -->
                    <div id="oneByOneSection" class="update-section scan-section" style="display: none;">
                        <div class="mb-3 text-center">
                            <button type="button" id="readyToScan" class="btn btn-success btn-lg">Ready to Scan</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Active Update Section -->
        <div id="activeUpdateSection" style="display: none;">
            <h1 class="mb-4" id="activeUpdateTitle">Update Title</h1>

            <!-- In your HTML, update the delayed jobs info section -->
            <div id="delayedJobsInfo" class="alert alert-info" style="display: none;">
                <h5><i class="fas fa-clock"></i> Delayed Processing</h5>
                <p id="delayedJobsMessage">Some jobs are queued for delayed processing (30 minutes). They will update to
                    "At Warehouse" and "In Sorting Area" automatically.</p>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2" id="loadingMessage">Processing... Please wait</p>
            </div>

            <!-- Bulk Results -->
            <div id="bulkResults" class="result-section">
                <h3>Update Results</h3>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-success">
                            <div class="card-body text-center">
                                <h5 class="card-title">Updated Now</h5>
                                <p class="card-text display-4" id="updatedCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title">Queued (5 min)</h5>
                                <p class="card-text display-4" id="delayedCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title">Failed</h5>
                                <p class="card-text display-4" id="failedCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info">
                            <div class="card-body text-center">
                                <h5 class="card-title">Duplicates</h5>
                                <p class="card-text display-4" id="duplicateCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add total count if needed -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card text-white bg-secondary">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Processed</h5>
                                <p class="card-text display-4" id="totalCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Tables -->
                <div id="resultsContainer"></div>

                <!-- Reset Button -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">Reset</button>
                </div>
            </div>

            <!-- One by One Interface -->
            <div id="oneByOneInterface" style="display: none;">
                <div id="scanResults" class="result-section"></div>
                <div class="mb-3">
                    <label for="trackingNumSingle" class="form-label">Scan or Enter Tracking Number:</label>
                    <input type="text" id="trackingNumSingle" name="trackingNumSingle" class="form-control"
                        placeholder="Scan or paste tracking number">
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        // Add these missing global variables at the top of your JavaScript
        let scanResults = {
            successful: [],
            failed: [],
            delayed: [],
            updatedCount: 0,
            notUpdatedCount: 0,
            delayedCount: 0,
            duplicateCount: 0 // Add duplicate count
        };

        let currentJobId = null;
        let pollInterval = null;
        // Simplified JavaScript for handling the form
        // Update the updateCode change event listener

        // GLOBAL TRACKING FOR DUPLICATES - FRONT-END VERSION
        const processedTrackingNumbers = {
            bulk: new Map(),
            onebyone: new Map()
        };

        // Front-end version of trackDuplicate function
        function trackDuplicate(trackingNumber, updateCode, updateMethod = 'bulk') {
            const key = `${updateCode}_${trackingNumber}`;
            const tracker = updateMethod === 'onebyone' ? processedTrackingNumbers.onebyone : processedTrackingNumbers.bulk;

            const now = Date.now();
            const oneHour = 60 * 60 * 1000;

            if (tracker.has(key)) {
                const data = tracker.get(key);

                // Clean old entries
                if (now - data.lastSeen > oneHour) {
                    tracker.delete(key);
                    // Recreate as new entry
                    tracker.set(key, {
                        trackingNumber: trackingNumber,
                        updateCode: updateCode,
                        count: 1,
                        firstSeen: now,
                        lastSeen: now,
                        processed: false,
                        method: updateMethod
                    });
                    return { isDuplicate: false, count: 1 };
                }

                data.count = (data.count || 1) + 1;
                data.lastSeen = now;
                tracker.set(key, data);
                return { isDuplicate: true, count: data.count };
            } else {
                // First time seeing this tracking number
                tracker.set(key, {
                    trackingNumber: trackingNumber,
                    updateCode: updateCode,
                    count: 1,
                    firstSeen: now,
                    lastSeen: now,
                    processed: false,
                    method: updateMethod
                });
                return { isDuplicate: false, count: 1 };
            }
        }

        document.getElementById('updateCode').addEventListener('change', async function () {
            const mawbFields = document.getElementById('mawbFields');
            const updateMethodSection = document.getElementById('updateMethod').closest('.mb-3');
            const updateMethod = document.getElementById('updateMethod');
            const mawbRequired = document.getElementById('mawbRequired');
            const mawbOptional = document.getElementById('mawbOptional');
            const mawbHelp = document.getElementById('mawbHelp');
            const warehouseFields = document.getElementById('warehouseFields');
            const warehouseSelect = document.getElementById('warehouse');
            const mawbNumContainer = document.getElementById('mawbNumContainer');
            const mawbSelect = document.getElementById('mawbNum');
            const mawbInput = document.getElementById('mawbNumInput');
            const mawbStats = document.getElementById('mawbStats');
            const bulkSection = document.getElementById('bulkSection');
            const oneByOneSection = document.getElementById('oneByOneSection');
            const readyToScan = document.getElementById('readyToScan');

            if (this.value === 'UAN' || this.value === 'CCH' || this.value === 'IIW' || this.value === 'UMN') {
                mawbFields.style.display = 'block';

                if (this.value === 'UAN') {
                    // MAWB Update - Excel Upload Only
                    mawbNumContainer.style.display = 'block';
                    mawbSelect.style.display = 'none';
                    mawbInput.style.display = 'block';
                    mawbStats.style.display = 'none';
                    mawbRequired.style.display = 'inline';
                    mawbOptional.style.display = 'none';
                    warehouseFields.style.display = 'none';
                    updateMethodSection.style.display = 'none'; // HIDE UPDATE METHOD
                    mawbInput.required = true;
                    warehouseSelect.required = false;
                    mawbHelp.textContent = 'MAWB Number for Excel upload processing';

                    // Hide bulk/one-by-one sections
                    bulkSection.style.display = 'none';
                    oneByOneSection.style.display = 'none';

                    // Show file upload button
                    showExcelUploadButton();

                } else if (this.value === 'UMN') {
                    // UMN Update - Show update method
                    mawbNumContainer.style.display = 'block';
                    mawbSelect.style.display = 'none';
                    mawbInput.style.display = 'block';
                    mawbStats.style.display = 'none';
                    mawbRequired.style.display = 'inline';
                    mawbOptional.style.display = 'none';
                    warehouseFields.style.display = 'none';
                    updateMethodSection.style.display = 'block'; // SHOW UPDATE METHOD
                    updateMethod.required = true;
                    mawbInput.required = true;
                    warehouseSelect.required = false;
                    mawbHelp.textContent = 'Enter MAWB Number for manual update (existing orders only)';
                    hideExcelUploadButton();

                    // Reset update method and hide sections
                    updateMethod.value = '';
                    bulkSection.style.display = 'none';
                    oneByOneSection.style.display = 'none';

                } else if (this.value === 'CCH') {
                    // On Hold - Show update method
                    mawbNumContainer.style.display = 'none';
                    warehouseFields.style.display = 'none';
                    updateMethodSection.style.display = 'block'; // SHOW UPDATE METHOD
                    updateMethod.required = true;
                    mawbInput.required = false;
                    warehouseSelect.required = false;
                    mawbHelp.textContent = 'No MAWB number required for On Hold';
                    hideExcelUploadButton();

                    // Reset update method and hide sections
                    updateMethod.value = '';
                    bulkSection.style.display = 'none';
                    oneByOneSection.style.display = 'none';

                } else if (this.value === 'IIW') {
                    // Item in Warehouse - Show dropdown with recent MAWBs
                    mawbNumContainer.style.display = 'block';
                    mawbSelect.style.display = 'block';
                    mawbInput.style.display = 'none';
                    mawbRequired.style.display = 'none';
                    mawbOptional.style.display = 'inline';
                    warehouseFields.style.display = 'block';
                    updateMethodSection.style.display = 'block'; // SHOW UPDATE METHOD
                    updateMethod.required = true;
                    mawbInput.required = false;
                    warehouseSelect.required = true;
                    mawbHelp.textContent = 'Select MAWB number for bulk scanning or leave empty for individual updates';
                    hideExcelUploadButton();

                    // Reset update method and hide sections
                    updateMethod.value = '';
                    bulkSection.style.display = 'none';
                    oneByOneSection.style.display = 'none';

                    // Load recent MAWBs
                    await loadRecentMAWBs();
                }
            } else {
                mawbFields.style.display = 'none';
                updateMethodSection.style.display = 'none';
                warehouseSelect.required = false;
                hideAllSections();
                hideExcelUploadButton();
            }
        });

        // Function to show Excel upload button
        function showExcelUploadButton() {
            let uploadButton = document.getElementById('excelUploadButton');
            if (!uploadButton) {
                uploadButton = document.createElement('button');
                uploadButton.id = 'excelUploadButton';
                uploadButton.type = 'button';
                uploadButton.className = 'btn btn-outline-success mt-2';
                uploadButton.innerHTML = '<i class="fas fa-file-excel"></i> Upload Excel/CSV File';
                uploadButton.onclick = showExcelUploadModal;

                const mawbContainer = document.getElementById('mawbNumContainer');
                if (mawbContainer) {
                    mawbContainer.appendChild(uploadButton);
                }
            } else {
                uploadButton.style.display = 'block';
            }
        }

        function hideExcelUploadButton() {
            const uploadButton = document.getElementById('excelUploadButton');
            if (uploadButton) {
                uploadButton.style.display = 'none';
            }
        }

        // In loadRecentMAWBs function:
        async function loadRecentMAWBs() {
            try {
                console.log('üîç Loading MAWBs with unscanned counts...');

                const response = await fetch('/updateJob/recentMAWBs');
                const data = await response.json();

                console.log('üìä MAWB data received:', data);

                const mawbSelect = document.getElementById('mawbNum');
                const mawbStats = document.getElementById('mawbStats');
                const mawbStatsText = document.getElementById('mawbStatsText');

                // Clear existing options
                while (mawbSelect.options.length > 1) {
                    mawbSelect.remove(1);
                }

                if (data.success && data.mawbs && data.mawbs.length > 0) {
                    console.log(`‚úÖ Found ${data.mawbs.length} MAWBs with unscanned jobs`);

                    // Add MAWB options with "Unscanned" label
                    data.mawbs.forEach(mawb => {
                        const option = document.createElement('option');
                        option.value = mawb.mawbNo;
                        // Format: MAWB (Unscanned / Total) - Product
                        option.textContent = `${mawb.mawbNo} (${mawb.unscannedJobs}/${mawb.totalJobs} Unscanned) - ${mawb.product}`;
                        option.setAttribute('data-total', mawb.totalJobs);
                        option.setAttribute('data-unscanned', mawb.unscannedJobs);
                        option.setAttribute('data-scanned', mawb.scannedJobs);
                        option.setAttribute('data-warehouse', mawb.atWarehouseJobs || 0);
                        option.setAttribute('data-product', mawb.product);
                        option.setAttribute('data-percentage-unscanned', mawb.percentageUnscanned);
                        option.setAttribute('data-percentage-scanned', mawb.percentageScanned);
                        mawbSelect.appendChild(option);
                    });

                    mawbStats.style.display = 'block';
                    mawbStatsText.textContent =
                        `Showing ${data.mawbs.length} MAWBs with ${data.summary?.totalUnscannedJobs || 0} unscanned jobs`;

                } else {
                    console.log('‚ö†Ô∏è No MAWBs found with unscanned jobs');

                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No MAWB numbers with unscanned jobs found';
                    option.disabled = true;
                    mawbSelect.appendChild(option);

                    mawbStats.style.display = 'block';
                    mawbStatsText.textContent = 'No MAWB numbers found with jobs still unscanned';
                }

            } catch (error) {
                console.error('‚ùå Error loading MAWBs:', error);

                const mawbSelect = document.getElementById('mawbNum');
                const mawbStats = document.getElementById('mawbStats');
                const mawbStatsText = document.getElementById('mawbStatsText');

                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Error loading MAWB numbers';
                option.disabled = true;
                mawbSelect.appendChild(option);

                mawbStats.style.display = 'block';
                mawbStatsText.textContent = `Error: ${error.message}`;
            }
        }

        document.getElementById('updateMethod').addEventListener('change', function () {
            hideAllSections();
            if (this.value === 'bulk') {
                document.getElementById('bulkSection').style.display = 'block';
            } else if (this.value === 'onebyone') {
                document.getElementById('oneByOneSection').style.display = 'block';
            }
        });

        // Add this function to validate MAWB number before processing
        async function validateMAWBForIIW(mawbNum, updateMethod) {
            try {
                console.log(`üîç Validating MAWB: ${mawbNum} for IIW ${updateMethod}`);

                const response = await fetch('/updateJob/validateMAWB', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mawbNum: mawbNum })
                });

                if (!response.ok) {
                    throw new Error(`Validation failed: ${response.status}`);
                }

                const data = await response.json();

                if (!data.exists) {
                    // MAWB doesn't exist - show alert and clear field
                    showMAWBAlert(`‚ö†Ô∏è MAWB Number "${mawbNum}" does not exist in the system.`, false);
                    return {
                        isValid: false,
                        message: 'MAWB not found'
                    };
                }

                // MAWB exists - return the stats
                return {
                    isValid: true,
                    exists: true,
                    totalJobs: data.totalJobs,
                    unscannedJobs: data.unscannedJobs,
                    scannedJobs: data.scannedJobs,
                    trackingNumbers: data.trackingNumbers || [],
                    mawbNum: data.mawbNum
                };

            } catch (error) {
                console.error('Error validating MAWB:', error);
                showMAWBAlert('Error validating MAWB: ' + error.message, false);
                return {
                    isValid: false,
                    message: 'Validation error: ' + error.message
                };
            }
        }

        // Show MAWB alert - Add this function too
        function showMAWBAlert(message, isSuccess) {
            const alertClass = isSuccess ? 'alert-success' : 'alert-danger';

            // Remove any existing alert
            const existingAlert = document.querySelector('.mawb-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show mawb-alert`;
            alertDiv.innerHTML = `
        <strong>${isSuccess ? '‚úÖ' : '‚ö†Ô∏è'} MAWB Validation:</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

            // Insert after the MAWB input
            const mawbContainer = document.getElementById('mawbNumContainer');
            if (mawbContainer) {
                mawbContainer.appendChild(alertDiv);
            }

            // Auto-remove after 5 seconds for success messages
            if (isSuccess) {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Also add these helper functions that are referenced:

        // Show MAWB stats for one-by-one scanning
        function showMAWBStatsForOneByOne(stats) {
            // Create or update stats display
            let statsDiv = document.getElementById('mawbOneByOneStats');

            if (!statsDiv) {
                statsDiv = document.createElement('div');
                statsDiv.id = 'mawbOneByOneStats';
                statsDiv.className = 'alert alert-info mb-3';

                // Insert before the scanning input
                const oneByOneInterface = document.getElementById('oneByOneInterface');
                if (oneByOneInterface) {
                    const scanInput = document.querySelector('#trackingNumSingle');
                    if (scanInput) {
                        oneByOneInterface.insertBefore(statsDiv, scanInput.parentNode);
                    } else {
                        oneByOneInterface.insertBefore(statsDiv, oneByOneInterface.firstChild);
                    }
                }
            }

            // Initialize counters
            window.mawbScanningStats = {
                mawbNum: stats.mawbNum,
                total: stats.totalJobs,
                scanned: stats.scannedJobs,
                unscanned: stats.unscannedJobs,
                newlyScanned: 0,
                skipped: 0,
                invalid: 0
            };

            updateMAWBOneByOneStatsDisplay();
        }

        // Update one-by-one stats display
        function updateMAWBOneByOneStatsDisplay() {
            const statsDiv = document.getElementById('mawbOneByOneStats');
            if (!statsDiv || !window.mawbScanningStats) return;

            const stats = window.mawbScanningStats;

            statsDiv.innerHTML = `
        <h5><i class="fas fa-boxes"></i> MAWB Group: ${stats.mawbNum}</h5>
        <div class="row">
            <div class="col-md-4">
                <p><strong>Total Jobs:</strong> ${stats.total}</p>
                <p><strong>To Be Scanned:</strong> ${stats.unscanned - stats.newlyScanned} remaining</p>
            </div>
            <div class="col-md-4">
                <p><strong>Already Scanned:</strong> ${stats.scanned} <span class="badge bg-success">At Warehouse</span></p>
                <p><strong>Newly Scanned:</strong> ${stats.newlyScanned} <span class="badge bg-info">Just Updated</span></p>
            </div>
            <div class="col-md-4">
                <p><strong>Skipped (Wrong MAWB):</strong> ${stats.invalid}</p>
                <p><strong>Skipped (Already Scanned):</strong> ${stats.skipped}</p>
            </div>
        </div>
        <div class="progress mt-2" style="height: 20px;">
            <div class="progress-bar bg-success" style="width: ${(stats.scanned / stats.total) * 100}%">
                Already Scanned (${stats.scanned})
            </div>
            <div class="progress-bar bg-info" style="width: ${(stats.newlyScanned / stats.total) * 100}%">
                Newly Scanned (${stats.newlyScanned})
            </div>
            <div class="progress-bar bg-warning" style="width: ${((stats.unscanned - stats.newlyScanned) / stats.total) * 100}%">
                Remaining (${stats.unscanned - stats.newlyScanned})
            </div>
        </div>
    `;
        }

        // Update the readyToScan event listener
        document.getElementById('readyToScan').addEventListener('click', async function () {
            const updateCode = document.getElementById('updateCode').value;
            const warehouse = document.getElementById('warehouse').value;
            const mawbNumInput = document.getElementById('mawbNum');
            const mawbNum = mawbNumInput ? mawbNumInput.value.trim() : '';

            if (updateCode === 'IIW' && !warehouse) {
                alert('Please select a warehouse location');
                return;
            }

            // If MAWB number is provided for IIW update, validate it
            if (updateCode === 'IIW' && mawbNum !== '') {
                const validation = await validateMAWBForIIW(mawbNum, 'onebyone');

                if (!validation.isValid) {
                    // Clear MAWB field if validation failed
                    if (mawbNumInput) {
                        mawbNumInput.value = '';
                    }
                    return;
                }

                // Show MAWB stats for one-by-one
                showMAWBStatsForOneByOne(validation);
            }

            // Proceed to active update mode
            switchToActiveUpdateMode(updateCode, 'onebyone');
        });

        document.getElementById('trackingNumSingle').addEventListener('change', async function () {
            const trackingNumber = this.value.trim();
            if (!trackingNumber) return;

            const updateCode = document.getElementById('updateCode').value;
            const warehouse = document.getElementById('warehouse') ? document.getElementById('warehouse').value : '';
            const mawbNum = document.getElementById('mawbNum') ? document.getElementById('mawbNum').value.trim() : '';

            // Clear the input field
            this.value = '';

            // Check for duplicate
            const duplicateCheck = trackDuplicate(trackingNumber, updateCode, 'onebyone');
            if (duplicateCheck.isDuplicate && duplicateCheck.count > 1) {
                console.log(`‚è≠Ô∏è Duplicate one-by-one: ${trackingNumber}`);
                scanResults.duplicateCount = (scanResults.duplicateCount || 0) + 1;
                updateScanResultsDisplayWithDuplicate(trackingNumber, duplicateCheck.count);

                setTimeout(() => {
                    this.focus();
                }, 100);
                return;
            }

            // For IIW with MAWB validation
            if (updateCode === 'IIW' && mawbNum !== '') {
                // Check if tracking belongs to this MAWB
                try {
                    const response = await fetch('/updateJob/checkTrackingForMAWB', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            trackingNumber: trackingNumber,
                            mawbNum: mawbNum
                        })
                    });

                    if (response.ok) {
                        const checkResult = await response.json();

                        if (!checkResult.belongsToMAWB) {
                            // Not part of this MAWB group
                            if (window.mawbScanningStats) {
                                window.mawbScanningStats.invalid++;
                                updateMAWBOneByOneStatsDisplay();
                            }

                            scanResults.failed.push({
                                trackingNumber: trackingNumber,
                                result: `Not part of MAWB ${mawbNum} group`
                            });
                            scanResults.notUpdatedCount++;
                            updateScanResultsDisplay();

                            // Show alert
                            showScanAlert(`‚ùå ${trackingNumber} is not part of MAWB ${mawbNum} group`, 'danger');

                            setTimeout(() => {
                                this.focus();
                            }, 100);
                            return;
                        }

                        // Check if already scanned
                        if (checkResult.warehouseEntry === "Yes") {
                            if (window.mawbScanningStats) {
                                window.mawbScanningStats.skipped++;
                                updateMAWBOneByOneStatsDisplay();
                            }

                            scanResults.failed.push({
                                trackingNumber: trackingNumber,
                                result: 'Already scanned (warehouseEntry: Yes)'
                            });
                            scanResults.notUpdatedCount++;
                            updateScanResultsDisplay();

                            showScanAlert(`‚ö†Ô∏è ${trackingNumber} already scanned`, 'warning');

                            setTimeout(() => {
                                this.focus();
                            }, 100);
                            return;
                        }

                        // Valid for scanning - update stats
                        if (window.mawbScanningStats) {
                            window.mawbScanningStats.newlyScanned++;
                            updateMAWBOneByOneStatsDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Error checking MAWB:', error);
                }
            }

            // Validation for different update codes
            if (updateCode === 'UAN' && !mawbNum) {
                alert('Please enter MAWB Number');
                setTimeout(() => {
                    this.focus();
                }, 100);
                return;
            }

            if (updateCode === 'IIW' && !warehouse) {
                alert('Please select a warehouse location');
                setTimeout(() => {
                    this.focus();
                }, 100);
                return;
            }

            showSingleLoading(true);

            try {
                console.log('Sending one-by-one update request...');

                const requestBody = {
                    updateCode: updateCode,
                    trackingNumbers: [trackingNumber],
                    updateMethod: 'onebyone'
                };

                // Add MAWB number for UAN updates
                if (updateCode === 'UAN' && mawbNum) {
                    requestBody.mawbNum = mawbNum;
                }

                // Add warehouse for IIW updates
                if (updateCode === 'IIW' && warehouse) {
                    requestBody.warehouse = warehouse;
                    // Also add mawbNum for IIW if provided
                    if (mawbNum !== '') {
                        requestBody.mawbNum = mawbNum;
                    }
                }

                const response = await fetch('/updateJob', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('One-by-one result:', result);

                // FIX: Check if result is defined before accessing properties
                if (!result) {
                    throw new Error('No result returned from server');
                }

                // Handle the result properly with safe checks
                if (result.successful && result.successful.length > 0) {
                    scanResults.successful.push(...result.successful);
                    scanResults.updatedCount += result.updatedCount || 0;
                }
                if (result.failed && result.failed.length > 0) {
                    scanResults.failed.push(...result.failed);
                    scanResults.notUpdatedCount += result.failedCount || result.failed.length || 0;
                }
                if (result.delayed && result.delayed.length > 0) {
                    scanResults.delayed.push(...result.delayed);
                    scanResults.delayedCount += result.delayedCount || result.delayed.length || 0;
                }
                if (result.duplicate && result.duplicate.length > 0) {
                    scanResults.duplicateCount = (scanResults.duplicateCount || 0) + (result.duplicateCount || 0);
                }

                updateScanResultsDisplay();

            } catch (error) {
                console.error('Error:', error);
                // Add to failed results
                scanResults.failed.push({
                    trackingNumber: trackingNumber,
                    result: 'Error: ' + error.message
                });
                scanResults.notUpdatedCount++;
                updateScanResultsDisplay();
            } finally {
                showSingleLoading(false);
                setTimeout(() => {
                    this.focus();
                }, 100);
            }
        });

        // Helper function to show scan alerts
        function showScanAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show scan-alert`;
            alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

            // Insert in scan results area
            const scanResultsDiv = document.getElementById('scanResults');
            if (scanResultsDiv) {
                scanResultsDiv.prepend(alertDiv);
            }

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Make sure this function properly updates the display
        function updateScanResultsDisplayWithDuplicate(trackingNumber, duplicateCount) {
            const scanResultsDiv = document.getElementById('scanResults');
            if (!scanResultsDiv) {
                console.error('scanResults element not found');
                return;
            }

            // Check if we need to create the results section
            if (scanResultsDiv.style.display === 'none' || scanResultsDiv.innerHTML === '') {
                // Initialize with basic structure
                scanResultsDiv.innerHTML = `
            <h3>Scanning Results</h3>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <h5 class="card-title">Updated</h5>
                            <p class="card-text display-4">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body text-center">
                            <h5 class="card-title">Failed</h5>
                            <p class="card-text display-4">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body text-center">
                            <h5 class="card-title">Delayed</h5>
                            <p class="card-text display-4">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <h5 class="card-title">Duplicates</h5>
                            <p class="card-text display-4" id="duplicateCountDisplay">1</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
                scanResultsDiv.style.display = 'block';
            } else {
                // Update duplicate count
                const duplicateCountElem = scanResultsDiv.querySelector('#duplicateCountDisplay') ||
                    scanResultsDiv.querySelector('.bg-info .display-4');
                if (duplicateCountElem) {
                    const currentCount = parseInt(duplicateCountElem.textContent) || 0;
                    duplicateCountElem.textContent = currentCount + 1;
                }
            }

            // Add duplicate alert at the top
            let currentHtml = scanResultsDiv.innerHTML;

            const duplicateAlert = `
        <div class="alert alert-info alert-dismissible fade show">
            <strong>‚ö†Ô∏è Duplicate:</strong> 
            ${trackingNumber} - Skipped (seen ${duplicateCount} times)
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

            // Insert at the beginning (after the title if exists)
            const titleIndex = currentHtml.indexOf('<h3>Scanning Results</h3>');
            if (titleIndex !== -1) {
                const afterTitle = currentHtml.indexOf('</h3>', titleIndex) + 5;
                scanResultsDiv.innerHTML = currentHtml.substring(0, afterTitle) + duplicateAlert + currentHtml.substring(afterTitle);
            } else {
                scanResultsDiv.innerHTML = duplicateAlert + currentHtml;
            }

            scanResultsDiv.scrollTop = 0;
        }

        // Update updateScanResultsDisplay to include duplicates
        function updateScanResultsDisplay() {
            const scanResultsDiv = document.getElementById('scanResults');
            if (!scanResultsDiv) {
                console.error('scanResults element not found');
                return;
            }

            let html = `
        <h3>Scanning Results</h3>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Updated</h5>
                        <p class="card-text display-4">${scanResults.updatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                        <h5 class="card-title">Failed</h5>
                        <p class="card-text display-4">${scanResults.notUpdatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">Delayed</h5>
                        <p class="card-text display-4">${scanResults.delayedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">Duplicates</h5>
                        <p class="card-text display-4">${scanResults.duplicateCount || 0}</p>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Show latest result at the top
            const allResults = [...scanResults.successful, ...scanResults.failed, ...scanResults.delayed];
            const latestResult = allResults[allResults.length - 1];

            if (latestResult) {
                const isSuccess = scanResults.successful.includes(latestResult);
                const isDelayed = scanResults.delayed.includes(latestResult);

                let alertClass = 'alert-danger';
                let icon = '‚ùå';
                let status = 'Failed';

                if (isSuccess) {
                    alertClass = 'alert-success';
                    icon = '‚úÖ';
                    status = 'Success';
                } else if (isDelayed) {
                    alertClass = 'alert-warning';
                    icon = '‚è∞';
                    status = 'Delayed';
                }

                html += `
            <div class="alert ${alertClass} alert-dismissible fade show">
                <strong>${icon} ${status}:</strong> 
                ${latestResult.trackingNumber} - ${latestResult.result || 'No result message'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
            }

            // Add successful jobs table if any
            if (scanResults.successful.length > 0) {
                const recentSuccessful = scanResults.successful.slice(-10).reverse();
                html += `
            <h4 class="text-success">Recently Updated</h4>
            <div class="table-responsive mb-3">
                <table class="table table-success table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentSuccessful.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Updated'}</small></td>
                                <td><small><span class="badge bg-success">Success</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // Add duplicate jobs table if any duplicates
            if (scanResults.duplicateCount > 0) {
                html += `
            <h4 class="text-info">Duplicates Skipped</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Duplicate tracking numbers were skipped and not processed again.
            </div>
            <div class="table-responsive mb-3">
                <table class="table table-info table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Duplicate Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="duplicateTableBody">
                        ${getRecentDuplicates().map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.count || 1}</small></td>
                                <td><small><span class="badge bg-info">Duplicate</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // In updateScanResultsDisplay function, update the delayed table
            if (scanResults.delayed.length > 0) {
                const recentDelayed = scanResults.delayed.slice(-10).reverse();
                html += `
        <h4 class="text-warning">Recently Delayed</h4>
        <div class="table-responsive mb-3">
            <table class="table table-warning table-striped table-sm">
                <thead>
                    <tr>
                        <th>Tracking Number</th>
                        <th>Scheduled Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentDelayed.map(item => `
                        <tr>
                            <td><small>${item.trackingNumber || 'N/A'}</small></td>
                            <td><small>${item.scheduledTime || '30 mins delay'}</small></td>
                            <td><small><span class="badge bg-warning">Scheduled</span></small></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
            }

            // Add failed jobs table if any
            if (scanResults.failed.length > 0) {
                const recentFailed = scanResults.failed.slice(-10).reverse();
                html += `
            <h4 class="text-danger">Recent Failures</h4>
            <div class="table-responsive">
                <table class="table table-danger table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentFailed.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Failed'}</small></td>
                                <td><small><span class="badge bg-danger">Failed</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            scanResultsDiv.innerHTML = html;
            scanResultsDiv.style.display = 'block';
            scanResultsDiv.scrollTop = scanResultsDiv.scrollHeight;
        }

        // Helper function to get recent duplicates
        function getRecentDuplicates() {
            const duplicates = [];
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();

            // Check both bulk and onebyone trackers
            for (const [key, data] of processedTrackingNumbers.onebyone.entries()) {
                if (data.count > 1 && (now - data.lastSeen) < oneHour) {
                    duplicates.push({
                        trackingNumber: data.trackingNumber,
                        count: data.count,
                        updateCode: data.updateCode,
                        lastSeen: new Date(data.lastSeen).toLocaleTimeString()
                    });
                }
            }

            return duplicates.slice(-10).reverse(); // Return last 10 duplicates
        }

        // Update form submission for bulk processing
        document.getElementById('updateJobForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const updateCode = document.getElementById('updateCode').value;

            // ========== ADD THIS CHECK FOR UAN ==========
            // For UAN, we handle it via Excel upload, not form submission
            if (updateCode === 'UAN') {
                alert('Please use the "Upload Excel/CSV File" button for UAN updates');
                return;
            }
            // ========== END OF UAN CHECK ==========

            const mawbSelect = document.getElementById('mawbNum');
            const mawbInput = document.getElementById('mawbNumInput');
            let mawbNum = '';

            // Get MAWB number based on which field is visible
            if (updateCode === 'IIW' && mawbSelect.style.display === 'block') {
                mawbNum = mawbSelect.value;
            } else if ((updateCode === 'UAN' || updateCode === 'UMN') && mawbInput.style.display === 'block') {
                mawbNum = mawbInput.value.trim();
            }

            const warehouse = document.getElementById('warehouse') ? document.getElementById('warehouse').value : '';
            const updateMethod = document.getElementById('updateMethod') ? document.getElementById('updateMethod').value : 'bulk';

            let trackingNumbers = [];

            // Get tracking numbers
            if (updateMethod === 'bulk') {
                const trackingNumBulk = document.getElementById('trackingNumBulk').value;
                trackingNumbers = trackingNumBulk.split('\n').map(num => num.trim()).filter(num => num !== '');
            } else if (updateMethod === 'onebyone') {
                return; // One-by-one handled separately
            }

            // ========== FIX THE DUPLICATE ALERT CHECK ==========
            if (trackingNumbers.length === 0 && updateMethod === 'bulk') {
                alert('Please enter tracking numbers');
                return;
            }
            // Remove the duplicate check below - it's redundant
            // ========== END FIX ==========

            // In form submission handler, update to use "unscanned" attribute:
            if (updateCode === 'IIW' && mawbNum) {
                const selectedOption = mawbSelect.options[mawbSelect.selectedIndex];
                const totalJobs = selectedOption.getAttribute('data-total');
                const unscannedJobs = selectedOption.getAttribute('data-unscanned');

                // Validate that we're not scanning more than unscanned jobs
                if (trackingNumbers.length > unscannedJobs) {
                    const proceed = confirm(
                        `Warning: You are trying to scan ${trackingNumbers.length} parcels, ` +
                        `but only ${unscannedJobs} are unscanned for MAWB ${mawbNum}.\n\n` +
                        `Do you want to continue? Some scans may fail if jobs are already scanned.`
                    );

                    if (!proceed) {
                        return;
                    }
                }
            }

            // For IIW with MAWB validation
            if (updateCode === 'IIW' && mawbNum !== '') {
                // Validate MAWB first
                const validation = await validateMAWBForIIW(mawbNum, 'bulk');

                if (!validation.isValid) {
                    // Clear MAWB field if validation failed
                    if (mawbInput) {
                        mawbInput.value = '';
                    }
                    return;
                }

                // Show MAWB stats for bulk
                showMAWBStatsForBulk(validation, trackingNumbers.length);

                // Filter tracking numbers to only include those in the MAWB group
                const originalCount = trackingNumbers.length;
                const mawbTrackingNumbers = validation.trackingNumbers || [];

                // Filter to only include tracking numbers that belong to this MAWB
                trackingNumbers = trackingNumbers.filter(tn =>
                    mawbTrackingNumbers.includes(tn)
                );

                if (trackingNumbers.length === 0) {
                    alert(`None of the entered tracking numbers belong to MAWB ${mawbNum}\n\nPlease enter tracking numbers that match this MAWB group.`);
                    return;
                }

                // Inform user about filtered results
                if (trackingNumbers.length < originalCount) {
                    const removedCount = originalCount - trackingNumbers.length;
                    showMAWBAlert(`Filtered out ${removedCount} tracking numbers that don't belong to MAWB ${mawbNum}. Processing ${trackingNumbers.length} valid items.`, true);
                }
            }

            // Count duplicates (for logging only)
            const trackingCounts = {};
            trackingNumbers.forEach(num => {
                trackingCounts[num] = (trackingCounts[num] || 0) + 1;
            });

            const duplicateEntries = Object.entries(trackingCounts)
                .filter(([num, count]) => count > 1);

            if (duplicateEntries.length > 0) {
                console.log(`Found ${duplicateEntries.length} duplicate tracking number(s) in input`);
            }

            // Validation for different update codes
            // ========== UPDATE UAN CHECK - IT SHOULD NEVER REACH HERE ==========
            // if (updateCode === 'UAN') {
            //     if (!mawbNum || mawbNum === '') {
            //         alert('Please enter MAWB Number');
            //         return;
            //     }
            // } else 
            if (updateCode === 'UMN') {
                if (!mawbNum || mawbNum === '') {
                    alert('Please enter MAWB Number');
                    return;
                }
            } else if (updateCode === 'IIW') {
                if (!warehouse) {
                    alert('Please select a warehouse location');
                    return;
                }
            }

            // Check if it's a large batch
            const LARGE_BATCH_THRESHOLD = 300;

            if (trackingNumbers.length > LARGE_BATCH_THRESHOLD) {
                // Use chunked processing for large batches
                processLargeBatchInChunks(trackingNumbers, updateCode, mawbNum, warehouse);
            } else {
                // Use normal processing for smaller batches
                processNormalBatch(trackingNumbers, updateCode, mawbNum, warehouse, updateMethod);
            }
        });

        // Show MAWB stats for bulk processing
        function showMAWBStatsForBulk(stats, enteredCount) {
            const statsHtml = `
        <div class="alert alert-info mb-3">
            <h5><i class="fas fa-boxes"></i> MAWB Group: ${stats.mawbNum}</h5>
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Total Jobs in MAWB:</strong> ${stats.totalJobs}</p>
                    <p><strong>Entered for Processing:</strong> ${enteredCount}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Already Scanned:</strong> ${stats.scannedJobs} <span class="badge bg-success">At Warehouse</span></p>
                    <p><strong>Will Be Scanned:</strong> ${stats.unscannedJobs} <span class="badge bg-warning">To Be Updated</span></p>
                </div>
                <div class="col-md-4">
                    <p><strong>Already at Warehouse:</strong> ${stats.scannedJobs} jobs</p>
                    <p><strong>Will be updated:</strong> Up to ${Math.min(stats.unscannedJobs, enteredCount)} jobs</p>
                </div>
            </div>
        </div>
    `;

            // Insert at the beginning of the active update section
            const activeSection = document.getElementById('activeUpdateSection');
            if (activeSection) {
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.insertAdjacentHTML('beforebegin', statsHtml);
                }
            }
        }

        // Update the displayBulkResults function - Add safe check for result object
        function displayBulkResults(result) {
            // ========== ADD THIS SAFETY CHECK ==========
            if (typeof result === 'undefined') {
                console.error("‚ùå displayBulkResults: result parameter is undefined");
                result = {
                    successful: [],
                    failed: [],
                    delayed: [],
                    duplicate: [],
                    updatedCount: 0,
                    failedCount: 0,
                    delayedCount: 0,
                    duplicateCount: 0,
                    total: 0
                };
            }
            // ========== END SAFETY CHECK ==========

            console.log("üìä displayBulkResults called with:", result);

            // SAFETY CHECK: If result is undefined or null
            if (!result) {
                console.error("‚ùå displayBulkResults: result is undefined or null");
                const bulkResults = document.getElementById('bulkResults');
                if (bulkResults) {
                    bulkResults.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error Displaying Results</h4>
                    <p>No results data received from server.</p>
                    <button class="btn btn-warning" onclick="location.reload()">Try Again</button>
                </div>
            `;
                    bulkResults.style.display = 'block';
                }
                return;
            }

            const bulkResults = document.getElementById('bulkResults');
            if (!bulkResults) {
                console.error('bulkResults element not found');
                return;
            }

            bulkResults.style.display = 'block';

            // Update counts with safe defaults
            const updatedCountElem = document.getElementById('updatedCount');
            const failedCountElem = document.getElementById('failedCount');
            const delayedCountElem = document.getElementById('delayedCount');
            const totalCountElem = document.getElementById('totalCount');
            const duplicateCountElem = document.getElementById('duplicateCount');

            // Use safe access with defaults
            const updatedCount = result.updatedCount || result.successful?.length || 0;
            const failedCount = result.failedCount || result.failed?.length || result.notUpdatedCount || 0;
            const delayedCount = result.delayedCount || result.delayed?.length || 0;
            const duplicateCount = result.duplicateCount || result.duplicate?.length || 0;
            const totalCount = result.total || result.totalJobs ||
                (updatedCount + failedCount + delayedCount + duplicateCount) || 0;

            if (updatedCountElem) updatedCountElem.textContent = updatedCount;
            if (failedCountElem) failedCountElem.textContent = failedCount;
            if (delayedCountElem) delayedCountElem.textContent = delayedCount;
            if (totalCountElem) totalCountElem.textContent = totalCount;
            if (duplicateCountElem) duplicateCountElem.textContent = duplicateCount;

            // Clear previous results container
            const resultsContainer = document.getElementById('resultsContainer');
            if (!resultsContainer) {
                console.error('resultsContainer element not found');
                return;
            }

            resultsContainer.innerHTML = '';

            // In displayBulkResults function, update the delayed alert
            if (delayedCount > 0) {
                const delayedJobsInfo = document.getElementById('delayedJobsInfo');
                if (delayedJobsInfo) {
                    delayedJobsInfo.style.display = 'block';
                    const message = document.getElementById('delayedJobsMessage');
                    if (message) {
                        message.textContent = `${delayedCount} job(s) are queued for delayed processing (30 minutes). They will update to "At Warehouse" automatically.`;
                    }
                }
            }

            // Create successful table if there are successful updates
            if (result.successful && result.successful.length > 0) {
                const successTable = document.createElement('div');
                successTable.innerHTML = `
        <h4 class="text-success mt-4">Successfully Processed Jobs (${result.successful.length})</h4>
        <div class="table-responsive">
            <table class="table table-success table-striped">
                <thead>
                    <tr>
                        <th>Tracking Number</th>
                        <th>Type</th>
                        <th>MAWB</th>
                        <th>Result</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${result.successful.map(item => `
                        <tr>
                            <td>${item.trackingNumber || 'N/A'}</td>
                            <td>
                                ${item.isNewOrder ?
                        '<span class="badge bg-info">New</span>' :
                        '<span class="badge bg-warning">Updated</span>'
                    }
                            </td>
                            <td>${item.mawbNum || 'N/A'}</td>
                            <td>${item.message || 'Updated'}</td>
                            <td><span class="badge bg-success">Success</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
                resultsContainer.appendChild(successTable);
            }

            // Create duplicate table if there are duplicates
            if (result.duplicate && result.duplicate.length > 0) {
                const duplicateTable = document.createElement('div');
                duplicateTable.innerHTML = `
            <h4 class="text-info mt-4">Duplicate Jobs (Ignored) (${result.duplicate.length})</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Duplicate tracking numbers were ignored and not processed again.
            </div>
            <div class="table-responsive">
                <table class="table table-info table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Duplicate Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.duplicate.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.duplicateCount || 1}</td>
                                <td><span class="badge bg-info">Ignored</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
                resultsContainer.appendChild(duplicateTable);
            }

            // Update delayed table in displayBulkResults
            if (result.delayed && result.delayed.length > 0) {
                const delayedTable = document.createElement('div');
                delayedTable.innerHTML = `
        <h4 class="text-warning mt-4">Delayed Jobs (30-minute wait) (${result.delayed.length})</h4>
        <div class="alert alert-warning">
            <strong>Note:</strong> These jobs have received immediate Detrack updates and will automatically update to "At Warehouse" and "In Sorting Area" after 30 minutes.
        </div>
        <div class="table-responsive">
            <table class="table table-warning table-striped">
                <thead>
                    <tr>
                        <th>Tracking Number</th>
                        <th>Product</th>
                        <th>Immediate Updates Applied</th>
                        <th>Scheduled Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="delayedTableBody">
                    ${result.delayed.map(item => `
                        <tr>
                            <td>${item.trackingNumber || 'N/A'}</td>
                            <td>${item.product || 'Unknown'}</td>
                            <td>${item.delayedInfo?.immediateUpdates?.join(', ') || 'None'}</td>
                            <td>${item.scheduledTime || '30 minutes delay'}</td>
                            <td><span class="badge bg-warning">Scheduled</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
                resultsContainer.appendChild(delayedTable);
            }

            // Create failed table if there are failed updates
            if (result.failed && result.failed.length > 0) {
                const failedTable = document.createElement('div');
                failedTable.innerHTML = `
        <h4 class="text-danger mt-4">Failed/Skipped Jobs (${result.failed.length})</h4>
        <div class="table-responsive">
            <table class="table table-danger table-striped">
                <thead>
                    <tr>
                        <th>Tracking Number</th>
                        <th>Reason</th>
                        <th>Details</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${result.failed.map(item => `
                        <tr>
                            <td>${item.trackingNumber || 'N/A'}</td>
                            <td>
                                ${item.skipped ?
                        '<span class="badge bg-warning">Skipped</span>' :
                        '<span class="badge bg-danger">Failed</span>'
                    }
                                ${item.reason ? `<br><small>${item.reason}</small>` : ''}
                            </td>
                            <td>${item.message || 'Failed'}</td>
                            <td>
                                ${item.skipped ?
                        '<span class="badge bg-warning">Skipped</span>' :
                        '<span class="badge bg-danger">Failed</span>'
                    }
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
                resultsContainer.appendChild(failedTable);
            }

            // If no results at all, show a message
            if ((!result.successful || result.successful.length === 0) &&
                (!result.duplicate || result.duplicate.length === 0) &&
                (!result.delayed || result.delayed.length === 0) &&
                (!result.failed || result.failed.length === 0)) {
                const noResults = document.createElement('div');
                noResults.className = 'alert alert-info';
                noResults.innerHTML = '<strong>No results to display.</strong>';
                resultsContainer.appendChild(noResults);
            }

            // Auto-scroll to results
            setTimeout(() => {
                bulkResults.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Create successful table if there are successful updates
        if (result.successful && result.successful.length > 0) {
            const successTable = document.createElement('div');
            successTable.innerHTML = `
            <h4 class="text-success mt-4">Successfully Updated Jobs (${result.successful.length})</h4>
            <div class="table-responsive">
                <table class="table table-success table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="successTableBody">
                        ${result.successful.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.result || 'Updated'}</td>
                                <td><span class="badge bg-success">Completed</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            resultsContainer.appendChild(successTable);
        }

        // Create duplicate table if there are duplicates
        if (result.duplicate && result.duplicate.length > 0) {
            const duplicateTable = document.createElement('div');
            duplicateTable.innerHTML = `
            <h4 class="text-info mt-4">Duplicate Jobs (Ignored) (${result.duplicate.length})</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Duplicate tracking numbers were ignored and not processed again.
            </div>
            <div class="table-responsive">
                <table class="table table-info table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Duplicate Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="duplicateTableBody">
                        ${result.duplicate.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.duplicateCount || 1}</td>
                                <td><span class="badge bg-info">Ignored</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            resultsContainer.appendChild(duplicateTable);
        }

        // Update delayed table in displayBulkResults
        if (result.delayed && result.delayed.length > 0) {
            const delayedTable = document.createElement('div');
            delayedTable.innerHTML = `
        <h4 class="text-warning mt-4">Delayed Jobs (5-minute wait for testing) (${result.delayed.length})</h4>
        <div class="alert alert-warning">
            <strong>Note:</strong> These jobs have received immediate Detrack updates and will automatically update to "At Warehouse" and "In Sorting Area" after 5 minutes (testing mode).
        </div>
        <div class="table-responsive">
            <table class="table table-warning table-striped">
                <thead>
                    <tr>
                        <th>Tracking Number</th>
                        <th>Product</th>
                        <th>Immediate Updates Applied</th>
                        <th>Scheduled Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="delayedTableBody">
                    ${result.delayed.map(item => `
                        <tr>
                            <td>${item.trackingNumber || 'N/A'}</td>
                            <td>${item.product || 'Unknown'}</td>
                            <td>${item.delayedInfo?.immediateUpdates?.join(', ') || 'None'}</td>
                            <td>${item.scheduledTime || '5 minutes delay for testing'}</td>
                            <td><span class="badge bg-warning">Scheduled</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
            resultsContainer.appendChild(delayedTable);
        }

        // Create failed table if there are failed updates
        if (result.failed && result.failed.length > 0) {
            const failedTable = document.createElement('div');
            failedTable.innerHTML = `
            <h4 class="text-danger mt-4">Failed Jobs (${result.failed.length})</h4>
            <div class="table-responsive">
                <table class="table table-danger table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="failedTableBody">
                        ${result.failed.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.result || 'Failed'}</td>
                                <td><span class="badge bg-danger">Failed</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            resultsContainer.appendChild(failedTable);
        }

        if (result.groupedByCustomer && result.groupedByCustomer.length > 0) {
            const groupedTable = document.createElement('div');
            groupedTable.innerHTML = `
        <h4 class="text-info mt-4">Grouped by Customer (${result.groupedByCustomer.length} groups)</h4>
        <div class="alert alert-info">
            <i class="fas fa-users"></i> These parcels can be grouped together for sorting
        </div>
        <div class="table-responsive">
            <table class="table table-info table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Customer Name</th>
                        <th>Area</th>
                        <th>Parcel Count</th>
                        <th>Tracking Numbers</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${result.groupedByCustomer.map((group, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${group.customerName || 'N/A'}</strong></td>
                            <td><span class="badge bg-secondary">${group.area || 'N/A'}</span></td>
                            <td><span class="badge bg-primary">${group.count}</span></td>
                            <td>
                                <small>
                                    ${group.trackingNumbers.slice(0, 3).map(tn =>
                `<div>${tn}</div>`
            ).join('')}
                                    ${group.trackingNumbers.length > 3 ?
                    `<div class="text-muted">+${group.trackingNumbers.length - 3} more</div>` :
                    ''
                }
                                </small>
                            </td>
                            <td><span class="badge ${group.status === 'Updated' ? 'bg-success' : 'bg-warning'}">
                                ${group.status}
                            </span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
            resultsContainer.appendChild(groupedTable);
        }

        // If no results at all, show a message
        if ((!result.successful || result.successful.length === 0) &&
            (!result.duplicate || result.duplicate.length === 0) &&
            (!result.delayed || result.delayed.length === 0) &&
            (!result.failed || result.failed.length === 0)) {
            const noResults = document.createElement('div');
            noResults.className = 'alert alert-info';
            noResults.innerHTML = '<strong>No results to display.</strong>';
            resultsContainer.appendChild(noResults);
        }

        // Auto-scroll to results
        setTimeout(() => {
            bulkResults.scrollIntoView({ behavior: 'smooth' });
        }, 100);

        // Also make sure this function is defined at the top level
        function getUpdateTitle(updateCode) {
            const updateTitles = {
                'UAN': 'MAWB Number Update',
                'CCH': 'On Hold Update',
                'IIW': 'Item in Warehouse Update',
                'OFD': 'Out for Delivery Update',
                'OSC': 'Self Collect Update',
                'FCC': 'Customer Not Available Update',
                'FIA': 'Incorrect Address Update',
                'FSC': 'Reschedule to Self Collect Update',
                'SFJ': 'Clear Job Update',
                'OSD': 'Swap Dispatchers Update',
                'UWL': 'Update Warehouse',
                'UGR': 'Update Go Rush Remark',
                'UJD': 'Update Job Date',
                'UJM': 'Update Job Method',
                'UJP': 'Update Price',
                'UAW': 'Update Weight',
                'UAS': 'Update Address',
                'UAR': 'Update Area',
                'UPN': 'Update Phone Number',
                'URN': 'Update Customer Name',
                'UPC': 'Update Postal Code',
                'UAB': 'Update AWB Number',
                'UCD': 'Cancelled Job Update',
                'URJ': 'Reactivate Job Update',
                'UDJ': 'Dispose Job Update'
            };

            return updateTitles[updateCode] || 'Update Job';
        }

        // Function to process large batches in chunks - UPDATED
        async function processLargeBatchInChunks(trackingNumbers, updateCode, mawbNum, warehouse) { // ADD warehouse parameter
            const CHUNK_SIZE = 200; // Process 200 items per chunk
            const chunks = [];

            // Split into chunks
            for (let i = 0; i < trackingNumbers.length; i += CHUNK_SIZE) {
                chunks.push(trackingNumbers.slice(i, i + CHUNK_SIZE));
            }

            // Show chunk processing UI
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('activeUpdateSection').style.display = 'block';
            document.getElementById('activeUpdateTitle').textContent = getUpdateTitle(updateCode) + ' (Chunked Processing)';
            document.getElementById('bulkResults').style.display = 'none';
            document.getElementById('oneByOneInterface').style.display = 'none';

            // Create chunk processing UI
            document.getElementById('loading').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Processing Large Batch</h4>
            <p>Total: ${trackingNumbers.length} items in ${chunks.length} chunks</p>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Overall Progress</h6>
                            <div class="progress" style="height: 25px;">
                                <div id="overallProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                            </div>
                            <small id="overallText">Starting...</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Current Chunk</h6>
                            <div class="progress" style="height: 25px;">
                                <div id="chunkProgress" class="progress-bar progress-bar-info progress-bar-striped" 
                                     role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                            </div>
                            <small id="chunkText">Chunk 0/${chunks.length}</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <h6>Total Updated</h6>
                            <h3 id="totalUpdated">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-danger">
                        <div class="card-body text-center">
                            <h6>Total Failed</h6>
                            <h3 id="totalFailed">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <h6>Current Chunk</h6>
                            <h3 id="currentChunkDisplay">1/${chunks.length}</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-warning" onclick="cancelChunkedProcessing()">Cancel Processing</button>
            </div>
        </div>
    `;
            document.getElementById('loading').style.display = 'block';

            // Initialize results
            const chunkedResults = {
                successful: [],
                failed: [],
                updatedCount: 0,
                notUpdatedCount: 0,
                completedChunks: 0,
                totalChunks: chunks.length,
                isCancelled: false
            };

            // Store globally for cancellation
            window.chunkedProcessing = {
                results: chunkedResults,
                isProcessing: true
            };

            // Process chunks sequentially with delay
            for (let i = 0; i < chunks.length; i++) {
                if (window.chunkedProcessing.isCancelled) break;

                // Update UI for current chunk
                document.getElementById('currentChunkDisplay').textContent = `${i + 1}/${chunks.length}`;
                document.getElementById('chunkProgress').style.width = `${((i + 1) / chunks.length) * 100}%`;
                document.getElementById('chunkProgress').textContent = `${Math.round(((i + 1) / chunks.length) * 100)}%`;
                document.getElementById('chunkText').textContent = `Processing chunk ${i + 1}/${chunks.length}`;

                try {
                    // Process this chunk - PASS warehouse parameter
                    const chunkResult = await processChunk(chunks[i], updateCode, mawbNum, warehouse, i); // ADD warehouse parameter

                    // Merge results
                    chunkedResults.successful.push(...chunkResult.successful);
                    chunkedResults.failed.push(...chunkResult.failed);
                    chunkedResults.updatedCount += chunkResult.updatedCount;
                    chunkedResults.notUpdatedCount += chunkResult.notUpdatedCount;
                    chunkedResults.completedChunks = i + 1;

                    // Update overall progress
                    const overallProgress = ((i + 1) / chunks.length) * 100;
                    document.getElementById('overallProgress').style.width = `${overallProgress}%`;
                    document.getElementById('overallProgress').textContent = `${Math.round(overallProgress)}%`;
                    document.getElementById('overallText').textContent =
                        `${chunkedResults.updatedCount} updated, ${chunkedResults.notUpdatedCount} failed`;

                    document.getElementById('totalUpdated').textContent = chunkedResults.updatedCount;
                    document.getElementById('totalFailed').textContent = chunkedResults.notUpdatedCount;

                    // Delay between chunks (except last one)
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay
                    }

                } catch (error) {
                    console.error(`Error processing chunk ${i + 1}:`, error);
                    // Add chunk to failed
                    chunks[i].forEach(trackingNumber => {
                        chunkedResults.failed.push({
                            trackingNumber: trackingNumber,
                            result: 'Chunk processing error'
                        });
                        chunkedResults.notUpdatedCount++;
                    });
                }
            }

            // Processing complete
            if (!window.chunkedProcessing.isCancelled) {
                document.getElementById('loading').style.display = 'none';
                displayBulkResults(chunkedResults);

                setTimeout(() => {
                    alert(`‚úÖ Large batch processing completed!\n\nSuccessfully updated: ${chunkedResults.updatedCount}\nFailed: ${chunkedResults.notUpdatedCount}\nProcessed in ${chunks.length} chunks`);
                }, 500);
            }

            window.chunkedProcessing.isProcessing = false;
        }

        // Function to process a single chunk - UPDATED
        async function processChunk(chunk, updateCode, mawbNum, warehouse, chunkIndex) { // ADD warehouse parameter
            try {
                const requestBody = {
                    updateCode: updateCode,
                    trackingNumbers: chunk,
                    updateMethod: 'bulk',
                    chunkIndex: chunkIndex
                };

                if (updateCode === 'UAN' && mawbNum) {
                    requestBody.mawbNum = mawbNum;
                }

                if (updateCode === 'IIW' && warehouse) { // ADD warehouse for IIW
                    requestBody.warehouse = warehouse;
                }

                const response = await fetch('/updateJob/chunk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.jobId) {
                    // Wait for chunk to complete
                    return await waitForChunkCompletion(result.jobId);
                } else {
                    // Direct result
                    return result;
                }

            } catch (error) {
                console.error('Chunk processing error:', error);
                throw error;
            }
        }

        // Wait for chunk job to complete
        async function waitForChunkCompletion(jobId) {
            const maxAttempts = 60; // 2 minutes max
            let attempts = 0;

            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(async () => {
                    attempts++;

                    try {
                        const response = await fetch(`/updateJob/status/${jobId}`);
                        const jobStatus = await response.json();

                        if (jobStatus.status === 'completed') {
                            clearInterval(checkInterval);
                            resolve(jobStatus);
                        } else if (jobStatus.status === 'failed' || attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(new Error('Chunk processing timeout or failed'));
                        }
                    } catch (error) {
                        console.error('Error checking chunk status:', error);
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(error);
                        }
                    }
                }, 2000); // Check every 2 seconds
            });
        }

        // Cancel chunked processing
        function cancelChunkedProcessing() {
            if (window.chunkedProcessing) {
                window.chunkedProcessing.isCancelled = true;
                alert('Processing cancelled. Partial results will be shown.');

                // Show partial results
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    displayBulkResults(window.chunkedProcessing.results);
                }, 500);
            }
        }

        // Update processNormalBatch to handle MAWB stats
        async function processNormalBatch(trackingNumbers, updateCode, mawbNum, warehouse, updateMethod) {
            // Switch to active update mode
            switchToActiveUpdateMode(updateCode, 'bulk');

            // Show loading with MAWB info if applicable
            let loadingHtml = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Starting processing...</p>
        <div class="progress mt-3" style="height: 25px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
        </div>
        <p id="progressText" class="mt-2">Initializing...</p>
        <p class="text-muted small">Processing ${trackingNumbers.length} jobs...</p>
    `;

            // Add MAWB info if provided for IIW
            if (updateCode === 'IIW' && mawbNum && mawbNum.trim() !== '') {
                loadingHtml = `
            <div class="alert alert-info mb-3">
                <h5><i class="fas fa-boxes"></i> Processing MAWB Group: ${mawbNum}</h5>
                <p>Filtered to ${trackingNumbers.length} valid tracking numbers</p>
            </div>
            ${loadingHtml}
        `;
            }

            document.getElementById('loading').innerHTML = loadingHtml;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('bulkResults').style.display = 'none';

            try {
                const requestBody = {
                    updateCode: updateCode,
                    trackingNumbers: trackingNumbers,
                    updateMethod: 'bulk'
                };

                if (updateCode === 'UAN' && mawbNum) {
                    requestBody.mawbNum = mawbNum;
                }

                if (updateCode === 'IIW' && warehouse) {
                    requestBody.warehouse = warehouse;
                    // Also add mawbNum for IIW if provided
                    if (mawbNum && mawbNum.trim() !== '') {
                        requestBody.mawbNum = mawbNum;
                    }
                }

                const response = await fetch('/updateJob', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.jobId) {
                    currentJobId = result.jobId;
                    startPollingResults();
                } else {
                    throw new Error('No job ID received for processing');
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                alert('An error occurred while starting the job: ' + error.message);
            }
        }

        function hideAllSections() {
            document.getElementById('bulkSection').style.display = 'none';
            document.getElementById('oneByOneSection').style.display = 'none';
        }

        function showSingleLoading(show) {
            const input = document.getElementById('trackingNumSingle');
            const loadingDiv = document.getElementById('loading');

            if (show) {
                input.disabled = true;
                input.placeholder = 'Processing...';
                input.style.backgroundColor = '#fff3cd';

                // Show minimal loading for single items
                loadingDiv.style.display = 'block';
                loadingDiv.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Updating...</span>
            `;
            } else {
                input.disabled = false;
                input.placeholder = 'Scan or paste tracking number';
                input.style.backgroundColor = '';
                loadingDiv.style.display = 'none';
            }
        }

        async function waitForJobCompletion(jobId, trackingNumber) {
            const maxAttempts = 30;
            let attempts = 0;

            return new Promise((resolve) => {
                const checkInterval = setInterval(async () => {
                    attempts++;

                    try {
                        const response = await fetch(`/updateJob/status/${jobId}`);
                        const jobStatus = await response.json();

                        if (jobStatus.status === 'completed') {
                            clearInterval(checkInterval);

                            // Update scan results
                            if (jobStatus.successful && jobStatus.successful.length > 0) {
                                scanResults.successful.push(...jobStatus.successful);
                                scanResults.updatedCount += jobStatus.updatedCount;
                            }
                            if (jobStatus.failed && jobStatus.failed.length > 0) {
                                scanResults.failed.push(...jobStatus.failed);
                                scanResults.notUpdatedCount += jobStatus.notUpdatedCount;
                            }

                            updateScanResultsDisplay();
                            resolve();
                        } else if (jobStatus.status === 'failed' || attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            scanResults.failed.push({
                                trackingNumber: trackingNumber,
                                result: 'Processing timeout or failed'
                            });
                            scanResults.notUpdatedCount++;
                            updateScanResultsDisplay();
                            resolve();
                        }
                    } catch (error) {
                        console.error('Error checking job status:', error);
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }
                }, 2000);
            });
        }

        function startPollingResults() {
            const startTime = Date.now();
            let lastProgressUpdate = 0;

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/updateJob/status/${currentJobId}`);
                    const jobStatus = await response.json();

                    // Update progress (same as bulk processing)
                    if (jobStatus.status === 'processing' || jobStatus.status === 'queued') {
                        const currentTime = Date.now();
                        const progress = jobStatus.total > 0 ? Math.round((jobStatus.processed / jobStatus.total) * 100) : 0;
                        const progressBar = document.getElementById('progressBar');
                        const progressText = document.getElementById('progressText');

                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${progress}%`;
                        }

                        if (currentTime - lastProgressUpdate > 2000 && progressText) {
                            lastProgressUpdate = currentTime;
                            const elapsedSeconds = (currentTime - startTime) / 1000;
                            let progressTextHtml = `Processed ${jobStatus.processed} of ${jobStatus.total} records`;

                            if (jobStatus.processed > 0 && elapsedSeconds > 5) {
                                const itemsPerSecond = jobStatus.processed / elapsedSeconds;
                                const remainingItems = jobStatus.total - jobStatus.processed;
                                const estimatedSeconds = remainingItems / itemsPerSecond;

                                if (estimatedSeconds > 0) {
                                    if (estimatedSeconds > 60) {
                                        const minutes = Math.floor(estimatedSeconds / 60);
                                        const seconds = Math.round(estimatedSeconds % 60);
                                        progressTextHtml += `<br>Estimated time remaining: ${minutes}min ${seconds}s`;
                                    } else {
                                        progressTextHtml += `<br>Estimated time remaining: ${Math.round(estimatedSeconds)}s`;
                                    }
                                    progressTextHtml += ` (${itemsPerSecond.toFixed(1)} records/sec)`;
                                }
                            }

                            if (progressText) {
                                progressText.innerHTML = progressTextHtml;
                            }
                        }
                    }

                    // Check if job is completed
                    if (jobStatus.status === 'completed') {
                        clearInterval(pollInterval);
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';

                        // Display results (same as bulk results)
                        if (typeof displayBulkResults === 'function') {
                            displayBulkResults(jobStatus);
                        } else {
                            console.error('displayBulkResults function is not defined');
                            location.reload();
                        }

                        // Show completion time
                        const totalSeconds = ((Date.now() - startTime) / 1000).toFixed(1);
                        setTimeout(() => {
                            alert(`‚úÖ Excel processing completed in ${totalSeconds} seconds!\n\nSuccessfully updated: ${jobStatus.updatedCount || 0}\nFailed: ${jobStatus.failedCount || 0}`);
                        }, 500);

                    } else if (jobStatus.status === 'failed') {
                        clearInterval(pollInterval);
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';
                        alert('‚ùå Excel processing failed: ' + (jobStatus.error || 'Unknown error'));
                    }

                } catch (error) {
                    console.error('Error polling job status:', error);

                    if (!window.pollErrorCount) {
                        window.pollErrorCount = 1;
                    } else {
                        window.pollErrorCount++;
                    }

                    if (window.pollErrorCount > 5) {
                        clearInterval(pollInterval);
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';
                        alert('‚ùå Connection error. Please check the results manually.');
                    }
                }
            }, 2000);
        }

        function updateScanResultsDisplay() {
            const scanResultsDiv = document.getElementById('scanResults');
            if (!scanResultsDiv) {
                console.error('scanResults element not found');
                return;
            }

            let html = `
        <h3>Scanning Results</h3>
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Updated</h5>
                        <p class="card-text display-4">${scanResults.updatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                        <h5 class="card-title">Failed</h5>
                        <p class="card-text display-4">${scanResults.notUpdatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">Delayed</h5>
                        <p class="card-text display-4">${scanResults.delayedCount}</p>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Show latest result at the top
            const allResults = [...scanResults.successful, ...scanResults.failed, ...scanResults.delayed];
            const latestResult = allResults[allResults.length - 1];

            if (latestResult) {
                const isSuccess = scanResults.successful.includes(latestResult);
                const isDelayed = scanResults.delayed.includes(latestResult);

                let alertClass = 'alert-danger';
                let icon = '‚ùå';
                let status = 'Failed';

                if (isSuccess) {
                    alertClass = 'alert-success';
                    icon = '‚úÖ';
                    status = 'Success';
                } else if (isDelayed) {
                    alertClass = 'alert-warning';
                    icon = '‚è∞';
                    status = 'Delayed';
                }

                html += `
            <div class="alert ${alertClass} alert-dismissible fade show">
                <strong>${icon} ${status}:</strong> 
                ${latestResult.trackingNumber} - ${latestResult.result || 'No result message'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
            }

            // Add successful jobs table if any
            if (scanResults.successful.length > 0) {
                const recentSuccessful = scanResults.successful.slice(-10).reverse();
                html += `
            <h4 class="text-success">Recently Updated</h4>
            <div class="table-responsive mb-3">
                <table class="table table-success table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentSuccessful.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Updated'}</small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // In updateScanResultsDisplay function, update the delayed table
            if (scanResults.delayed.length > 0) {
                const recentDelayed = scanResults.delayed.slice(-10).reverse();
                html += `
        <h4 class="text-warning">Recently Delayed</h4>
        <div class="table-responsive mb-3">
            <table class="table table-warning table-striped table-sm">
                <thead>
                    <tr>
                        <th>Tracking Number</th>
                        <th>Scheduled Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentDelayed.map(item => `
                        <tr>
                            <td><small>${item.trackingNumber || 'N/A'}</small></td>
                            <td><small>${item.scheduledTime || '30 mins delay'}</small></td>
                            <td><small><span class="badge bg-warning">Scheduled</span></small></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
            }

            // Add failed jobs table if any
            if (scanResults.failed.length > 0) {
                const recentFailed = scanResults.failed.slice(-10).reverse();
                html += `
            <h4 class="text-danger">Recent Failures</h4>
            <div class="table-responsive">
                <table class="table table-danger table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentFailed.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Failed'}</small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            scanResultsDiv.innerHTML = html;
            scanResultsDiv.style.display = 'block';
            scanResultsDiv.scrollTop = scanResultsDiv.scrollHeight;
        }

        // Add this function to check and handle duplicates
        function checkAndHandleDuplicate(trackingNumber, updateCode) {
            const key = `${updateCode}_${trackingNumber}`;
            const now = Date.now();

            if (processedTrackingNumbers.has(key)) {
                const lastProcessed = processedTrackingNumbers.get(key);
                const timeDiff = now - lastProcessed.timestamp;

                // Increment duplicate count
                lastProcessed.count = (lastProcessed.count || 1) + 1;
                lastProcessed.timestamp = now;
                processedTrackingNumbers.set(key, lastProcessed);

                console.log(`‚ö†Ô∏è Duplicate tracking number detected: ${trackingNumber} (${updateCode}), count: ${lastProcessed.count}`);
                return {
                    isDuplicate: true,
                    count: lastProcessed.count
                };
            } else {
                // First time processing this tracking number
                processedTrackingNumbers.set(key, {
                    timestamp: now,
                    count: 1
                });
                return {
                    isDuplicate: false,
                    count: 1
                };
            }
        }

        // Clean up old entries (older than 1 hour)
        setInterval(() => {
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();

            // Clean bulk tracker
            for (const [key, data] of processedTrackingNumbers.bulk.entries()) {
                if (now - data.lastSeen > oneHour) {
                    processedTrackingNumbers.bulk.delete(key);
                }
            }

            // Clean onebyone tracker
            for (const [key, data] of processedTrackingNumbers.onebyone.entries()) {
                if (now - data.lastSeen > oneHour) {
                    processedTrackingNumbers.onebyone.delete(key);
                }
            }

            console.log(`üßπ Front-end cleanup: Bulk: ${processedTrackingNumbers.bulk.size}, OneByOne: ${processedTrackingNumbers.onebyone.size}`);
        }, 5 * 60 * 1000); // Run every 5 minutes

        // Update the processSingleTrackingNumber function to handle duplicates
        async function processSingleTrackingNumber(trackingNumber, updateCode, mawbNum, warehouse, req) {
            const cleanTrackingNumber = trackingNumber.trim();

            if (!cleanTrackingNumber) {
                return { success: false, error: 'Empty tracking number', isDuplicate: false };
            }

            // Check for duplicate
            const duplicateCheck = checkAndHandleDuplicate(cleanTrackingNumber, updateCode);
            if (duplicateCheck.isDuplicate && duplicateCheck.count > 1) {
                return {
                    success: false,
                    error: `Duplicate tracking number (count: ${duplicateCheck.count})`,
                    trackingNumber: cleanTrackingNumber,
                    isDuplicate: true,
                    duplicateCount: duplicateCheck.count
                };
            }

            try {
                console.log(`üîç Processing ${cleanTrackingNumber} with updateCode: ${updateCode}`);

                let processSuccess = false;
                let message = '';

                switch (updateCode) {
                    case 'UAN':
                        processSuccess = await processMAWBUpdate(cleanTrackingNumber, mawbNum, req);
                        message = processSuccess ? `MAWB Number updated to ${mawbNum}` : 'MAWB update failed';
                        break;
                    case 'CCH':
                        processSuccess = await processOnHoldUpdate(cleanTrackingNumber, req);
                        message = processSuccess ? 'Job put on hold' : 'On hold update failed';
                        break;
                    case 'IIW':
                        const result = await processItemInWarehouseUpdate(cleanTrackingNumber, warehouse, req);
                        processSuccess = result.success;
                        message = result.message;
                        break;
                    default:
                        console.log(`‚ö†Ô∏è Generic update called for ${updateCode}`);
                        processSuccess = await processGenericUpdate(cleanTrackingNumber, updateCode, req, mawbNum);
                        message = processSuccess ? `Updated with ${updateCode}` : `${updateCode} update failed`;
                }

                console.log(`üìä Result for ${cleanTrackingNumber}: ${processSuccess ? 'SUCCESS' : 'FAILED'} - ${message}`);

                return {
                    success: processSuccess,
                    message: message,
                    trackingNumber: cleanTrackingNumber,
                    isDuplicate: false,
                    duplicateCount: 1
                };

            } catch (error) {
                console.error(`‚ùå Error processing ${cleanTrackingNumber}:`, error);
                return {
                    success: false,
                    error: error.message,
                    trackingNumber: cleanTrackingNumber,
                    isDuplicate: false,
                    duplicateCount: 1
                };
            }
        }

        async function processBatch(batch, updateCode, mawbNum, warehouse, req) {
            console.log(`üîÑ Processing batch of ${batch.length} items with updateCode: ${updateCode}`);

            const batchPromises = batch.map(async (trackingNumber) => {
                try {
                    // Check for duplicate
                    const duplicateCheck = trackDuplicate(trackingNumber, updateCode, 'bulk');

                    if (duplicateCheck.isDuplicate && duplicateCheck.count > 1) {
                        // This is a duplicate - skip processing
                        console.log(`‚è≠Ô∏è Skipping duplicate: ${trackingNumber} (seen ${duplicateCheck.count} times)`);
                        return {
                            success: false,
                            message: `Duplicate tracking number (count: ${duplicateCheck.count})`,
                            isDuplicate: true,
                            duplicateCount: duplicateCheck.count
                        };
                    }

                    // Mark as being processed
                    const key = `${updateCode}_${trackingNumber}`;
                    const data = processedTrackingNumbers.bulk.get(key);
                    if (data) {
                        data.processed = true;
                        processedTrackingNumbers.bulk.set(key, data);
                    }

                    // Process the update
                    if (updateCode === 'IIW') {
                        return await processItemInWarehouseUpdate(trackingNumber, warehouse, req);
                    } else if (updateCode === 'UAN') {
                        const success = await processMAWBUpdate(trackingNumber, mawbNum, req);
                        return {
                            success: success,
                            message: success ? `MAWB updated to ${mawbNum}` : 'MAWB update failed'
                        };
                    } else if (updateCode === 'CCH') {
                        const success = await processOnHoldUpdate(trackingNumber, req);
                        return {
                            success: success,
                            message: success ? 'Put on hold' : 'On hold update failed'
                        };
                    } else {
                        return {
                            success: false,
                            message: `Unsupported update code: ${updateCode}`
                        };
                    }
                } catch (error) {
                    console.error(`‚ùå Error processing ${trackingNumber}:`, error);
                    return {
                        success: false,
                        message: 'Error: ' + error.message
                    };
                }
            });

            const batchResults = await Promise.allSettled(batchPromises);

            // Process results
            const results = {
                successful: [],
                failed: [],
                delayed: [],
                duplicate: [],
                updatedCount: 0,
                failedCount: 0,
                delayedCount: 0,
                duplicateCount: 0
            };

            batchResults.forEach((result, index) => {
                const trackingNumber = batch[index];

                if (result.status === 'fulfilled' && result.value) {
                    const value = result.value;

                    if (value.isDuplicate) {
                        results.duplicate.push({
                            trackingNumber: trackingNumber,
                            result: value.message || 'Duplicate tracking number',
                            duplicateCount: value.duplicateCount || 1,
                            status: "Duplicate"
                        });
                        results.duplicateCount++;
                    } else if (value.delayed) {
                        results.delayed.push({
                            trackingNumber: trackingNumber,
                            result: value.message,
                            product: value.delayedInfo?.product,
                            scheduledTime: value.delayedInfo?.scheduledTime,
                            currentStatus: value.delayedInfo?.currentStatus,
                            status: "Queued (5 min)"
                        });
                        results.delayedCount++;
                    } else if (value.success) {
                        results.successful.push({
                            trackingNumber: trackingNumber,
                            result: value.message,
                            status: "Updated"
                        });
                        results.updatedCount++;
                    } else {
                        results.failed.push({
                            trackingNumber: trackingNumber,
                            result: value.message,
                            status: "Failed"
                        });
                        results.failedCount++;
                    }
                } else {
                    results.failed.push({
                        trackingNumber: trackingNumber,
                        result: 'Processing error',
                        status: "Error"
                    });
                    results.failedCount++;
                }
            });

            console.log(`üìä Batch results: ${results.updatedCount} updated, ${results.failedCount} failed, ${results.delayedCount} delayed, ${results.duplicateCount} duplicates`);
            return results;
        }

        function getUpdateTitle(updateCode) {
            const updateTitles = {
                'UAN': 'MAWB Number Update',
                'CCH': 'On Hold Update',
                'IIW': 'Item in Warehouse Update',
                'OFD': 'Out for Delivery Update',
                'OSC': 'Self Collect Update',
                'FCC': 'Customer Not Available Update',
                'FIA': 'Incorrect Address Update',
                'FSC': 'Reschedule to Self Collect Update',
                'SFJ': 'Clear Job Update',
                'OSD': 'Swap Dispatchers Update',
                'UWL': 'Update Warehouse',
                'UGR': 'Update Go Rush Remark',
                'UJD': 'Update Job Date',
                'UJM': 'Update Job Method',
                'UJP': 'Update Price',
                'UAW': 'Update Weight',
                'UAS': 'Update Address',
                'UAR': 'Update Area',
                'UPN': 'Update Phone Number',
                'URN': 'Update Customer Name',
                'UPC': 'Update Postal Code',
                'UAB': 'Update AWB Number',
                'UCD': 'Cancelled Job Update',
                'URJ': 'Reactivate Job Update',
                'UDJ': 'Dispose Job Update'
            };

            return updateTitles[updateCode] || 'Update Job';
        }

        function switchToActiveUpdateMode(updateCode, method) {
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('activeUpdateSection').style.display = 'block';

            const title = getUpdateTitle(updateCode);
            document.getElementById('activeUpdateTitle').textContent = title;

            if (method === 'bulk') {
                document.getElementById('bulkResults').style.display = 'none';
                document.getElementById('oneByOneInterface').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            } else if (method === 'onebyone') {
                document.getElementById('bulkResults').style.display = 'none';
                document.getElementById('oneByOneInterface').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('trackingNumSingle').focus();
                }, 300);
            }
        }

        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        });

        function resetToInitialMode() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            currentJobId = null;
            location.reload();
        }

        // Add a cancel job button (optional enhancement)
        function addCancelButton() {
            const resultsDiv = document.getElementById('bulkResults');
            if (resultsDiv && currentJobId) {
                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn btn-warning me-2';
                cancelButton.textContent = 'Cancel Job';
                cancelButton.onclick = async () => {
                    if (confirm('Are you sure you want to cancel this job?')) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        currentJobId = null;
                        document.getElementById('loading').style.display = 'none';
                        alert('Job cancelled');
                    }
                };

                const buttonContainer = resultsDiv.querySelector('.d-grid');
                if (buttonContainer) {
                    buttonContainer.prepend(cancelButton);
                }
            }
        }

        // In the showExcelUploadModal function, update to include MAWB input
        function showExcelUploadModal() {
            const mawbInput = document.getElementById('mawbNumInput');
            const mawbNum = mawbInput ? mawbInput.value.trim() : '';

            if (!mawbNum) {
                alert('Please enter MAWB Number first');
                return;
            }

            // Create modal HTML - Include MAWB number in the modal
            const modalHTML = `
        <div class="modal fade" id="excelUploadModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload Excel/CSV File for MAWB: ${mawbNum}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                       <div class="alert alert-info">
    <h6><i class="fas fa-info-circle"></i> File Requirements:</h6>
    <ul class="mb-2">
        <li><strong>Required columns:</strong> Tracking Number</li>
        <li><strong>Optional columns:</strong> Postal Code, Parcel Weight (kg)</li>
        <li><strong>MAWB Number:</strong> From form input above</li>
        <li><strong>Formats:</strong> .xlsx, .xls, .csv</li>
        <li><strong>Status requirement:</strong> Only jobs with "Info Received" status</li>
        <li><strong>Product requirement:</strong> Only mglobal, pdu, ewe, gdex, gdext products</li>
        <li><strong>Max records:</strong> 3000 per file</li>
    </ul>
</div>
                        
                        <div class="mb-3">
                            <label for="excelFile" class="form-label">Select File:</label>
                            <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls,.csv">
                            <div class="form-text">File must contain "Tracking Number" column</div>
                        </div>
                        
                        <div class="mb-3">
                            <input type="hidden" id="uploadMAWB" value="${mawbNum}">
                            <button type="button" class="btn btn-success" onclick="uploadExcelFile('${mawbNum}')">
                                <i class="fas fa-upload"></i> Upload & Process
                            </button>
                            <div class="btn-group ms-2" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="generateTemplate('excel')">
        <i class="fas fa-file-excel"></i> Excel Template
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="generateTemplate('csv')">
        <i class="fas fa-file-csv"></i> CSV Template
    </button>
</div>
                        </div>
                        
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div id="uploadProgressBar" class="progress-bar progress-bar-striped" 
                                     role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <p id="uploadStatus" class="mt-2 small"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Add modal to page if not exists
            let modal = document.getElementById('excelUploadModal');
            if (!modal) {
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);
                modal = document.getElementById('excelUploadModal');
            }

            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Reset file input and progress
            document.getElementById('excelFile').value = '';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadProgressBar').style.width = '0%';
            document.getElementById('uploadProgressBar').textContent = '0%';
            document.getElementById('uploadProgressBar').className = 'progress-bar progress-bar-striped';
        }

        async function uploadExcelFile(mawbNum) {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!mawbNum || mawbNum.trim() === '') {
                alert('MAWB Number is required');
                return;
            }

            console.log('üìÅ Uploading file for MAWB:', mawbNum);

            const formData = new FormData();
            formData.append('excelFile', file);
            formData.append('mawbNum', mawbNum); // Add MAWB to form data

            // Show progress
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            const uploadStatus = document.getElementById('uploadStatus');

            uploadProgress.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';
            uploadStatus.textContent = 'Uploading file...';

            try {
                console.log('üöÄ Sending upload request...');

                const response = await fetch('/updateJob/excelUpload', {
                    method: 'POST',
                    body: formData
                    // Don't set Content-Type header for FormData
                });

                console.log('üì• Response received:', response.status, response.statusText);

                if (!response.ok) {
                    // Try to get more error details
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorDetails = JSON.stringify(errorData);
                    } catch (e) {
                        errorDetails = await response.text();
                    }

                    console.error('‚ùå Upload failed details:', errorDetails);
                    throw new Error(`Upload failed: ${response.status} - ${response.statusText}\nDetails: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('‚úÖ Upload successful, result:', result);

                if (result.jobId) {
                    uploadStatus.textContent = 'File uploaded successfully. Processing in background...';
                    uploadProgressBar.style.width = '100%';
                    uploadProgressBar.textContent = '100%';

                    // Close modal after delay
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('excelUploadModal'));
                        if (modal) modal.hide();
                    }, 1000);

                    // Switch to active update mode to show progress
                    switchToActiveUpdateMode('UAN', 'bulk');
                    currentJobId = result.jobId;

                    // Show loading with file info
                    document.getElementById('loading').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4>Processing Excel Upload</h4>
                    <p>File: ${file.name}</p>
                    <p>Total Records: ${result.totalJobs || 'Unknown'}</p>
                    <div class="progress mt-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                    </div>
                    <p id="progressText" class="mt-2">Starting processing...</p>
                </div>
            `;
                    document.getElementById('loading').style.display = 'block';

                    // Start polling for results
                    startPollingResults();

                } else {
                    throw new Error('No job ID received from server');
                }

            } catch (error) {
                console.error('‚ùå Upload error:', error);
                uploadStatus.textContent = `Error: ${error.message}`;
                uploadProgressBar.className = 'progress-bar progress-bar-striped bg-danger';
                uploadProgressBar.textContent = 'Error';

                // Show detailed error to user
                alert(`Upload failed:\n\n${error.message}\n\nCheck console for details.`);
            }
        }

        // ==================================================
        // üìÑ Generate Excel/CSV Template
        // ==================================================

        function generateTemplate(format) {
            try {
                console.log(`üìã Generating ${format} template...`);

                // Get MAWB number from input (if available)
                const mawbInput = document.getElementById('mawbNumInput');
                const currentMAWB = mawbInput ? mawbInput.value.trim() : 'MAWB_EXAMPLE';

                if (format === 'excel') {
                    // For Excel, we need to use a library or create proper XLSX
                    // Since we don't have xlsx library in frontend, create CSV but with .xls extension
                    // Excel can open CSV with .xls extension
                    generateExcelTemplate(currentMAWB);
                } else {
                    generateCSVTemplate(currentMAWB);
                }

            } catch (error) {
                console.error(`‚ùå Error generating ${format} template:`, error);
                alert(`Error generating template: ${error.message}\n\nTry the CSV template instead.`);
            }
        }

        // Generate proper CSV template
        function generateCSVTemplate(mawbNum = 'MAWB_EXAMPLE') {
            const csvContent = `Tracking Number,Postal Code,Parcel Weight (kg)
EXAMPLE001,BE1234,1.5
EXAMPLE002,BE5678,2.0
EXAMPLE003,,0.8
EXAMPLE004,BE9012,

=== INSTRUCTIONS FOR MAWB: ${mawbNum} ===
1. Tracking Number is REQUIRED
2. Postal Code and Parcel Weight are OPTIONAL
3. MAWB Number will be taken from form: ${mawbNum}
4. Do NOT modify column headers
5. Save as .csv file
6. Only jobs with "Info Received" status will be processed
7. Maximum 3000 records per file
8. Remove sample data before uploading`;

            downloadFile(csvContent, 'text/csv', `UAN_template_${mawbNum}.csv`);
            console.log(`‚úÖ CSV template generated for MAWB: ${mawbNum}`);
        }

        // Generate Excel template (CSV with .xls extension - Excel can open it)
        function generateExcelTemplate(mawbNum = 'MAWB_EXAMPLE') {
            // Create CSV content but save as .xls
            const csvContent = `Tracking Number\tPostal Code\tParcel Weight (kg)
EXAMPLE001\tBE1234\t1.5
EXAMPLE002\tBE5678\t2.0
EXAMPLE003\t\t0.8
EXAMPLE004\tBE9012\t

=== INSTRUCTIONS FOR MAWB: ${mawbNum} ===
1. Tracking Number is REQUIRED
2. Postal Code and Parcel Weight are OPTIONAL
3. MAWB Number will be taken from form: ${mawbNum}
4. Do NOT modify column headers
5. Save as .xls or .xlsx file
6. Only jobs with "Info Received" status will be processed
7. Maximum 3000 records per file
8. Remove sample data before uploading`;

            // Use tab-separated values for better Excel compatibility
            downloadFile(csvContent, 'application/vnd.ms-excel', `UAN_template_${mawbNum}.xls`);
            console.log(`‚úÖ Excel template generated for MAWB: ${mawbNum}`);
        }

        // Helper function to download files
        function downloadFile(content, mimeType, fileName) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Update modal buttons to show better labels
        function updateTemplateButtons() {
            const mawbInput = document.getElementById('mawbNumInput');
            if (mawbInput && mawbInput.style.display === 'block') {
                const mawbNum = mawbInput.value.trim() || 'EXAMPLE';

                // Update button text if buttons exist
                const excelBtn = document.querySelector('button[onclick*="generateTemplate(\'excel\')"]');
                const csvBtn = document.querySelector('button[onclick*="generateTemplate(\'csv\')"]');

                if (excelBtn) {
                    excelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Excel Template (${mawbNum})`;
                }
                if (csvBtn) {
                    csvBtn.innerHTML = `<i class="fas fa-file-csv"></i> CSV Template (${mawbNum})`;
                }
            }
        }

        // Call this when MAWB input changes
        document.getElementById('mawbNumInput')?.addEventListener('input', updateTemplateButtons);

        // Optional: Track template downloads
        function trackTemplateDownload(format) {
            console.log(`üì• Template downloaded: ${format} format`);

            // You can send analytics here if needed
            try {
                fetch('/api/track/template-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        format: format,
                        timestamp: new Date().toISOString(),
                        updateCode: 'UAN'
                    })
                }).catch(error => {
                    console.log('Template download tracking failed:', error);
                });
            } catch (error) {
                console.log('Template download tracking error:', error);
            }
        }

        // Update the MAWB selection change event listener:
        document.getElementById('mawbNum').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const unscanned = selectedOption.getAttribute('data-unscanned');
            const scanned = selectedOption.getAttribute('data-scanned');
            const total = selectedOption.getAttribute('data-total');
            const warehouse = selectedOption.getAttribute('data-warehouse');
            const product = selectedOption.getAttribute('data-product');
            const percentageUnscanned = selectedOption.getAttribute('data-percentage-unscanned');
            const percentageScanned = selectedOption.getAttribute('data-percentage-scanned');

            if (this.value) {
                // Create or update status display
                let statusDiv = document.getElementById('mawbStatusDetails');
                if (!statusDiv) {
                    statusDiv = document.createElement('div');
                    statusDiv.id = 'mawbStatusDetails';
                    statusDiv.className = 'alert alert-info mt-2';
                    this.parentNode.appendChild(statusDiv);
                }

                const otherJobs = total - unscanned - scanned;
                const percentageOther = Math.round(otherJobs / total * 100);

                statusDiv.innerHTML = `
            <h6>MAWB ${this.value} Status Breakdown (${product}):</h6>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Unscanned (Info Received):</strong> ${unscanned} jobs <span class="badge bg-warning">${percentageUnscanned}%</span></p>
                    <p><strong>Scanned (Processing):</strong> ${scanned} jobs <span class="badge bg-info">${percentageScanned}%</span></p>
                    <p><strong>At Warehouse:</strong> ${warehouse} jobs</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Other Status:</strong> ${otherJobs} jobs <span class="badge bg-secondary">${percentageOther}%</span></p>
                    <p><strong>Total Jobs:</strong> ${total}</p>
                    <p><strong>Ready to Scan:</strong> ${unscanned} unscanned jobs</p>
                </div>
            </div>
            <div class="progress mt-2" style="height: 20px;">
                <div class="progress-bar bg-warning" style="width: ${percentageUnscanned}%">
                    Unscanned (${percentageUnscanned}%)
                </div>
                <div class="progress-bar bg-info" style="width: ${percentageScanned}%">
                    Scanned (${percentageScanned}%)
                </div>
                <div class="progress-bar bg-success" style="width: ${(warehouse / total * 100)}%">
                    At Warehouse (${Math.round(warehouse / total * 100)}%)
                </div>
                <div class="progress-bar bg-secondary" style="width: ${percentageOther}%">
                    Other (${percentageOther}%)
                </div>
            </div>
        `;
            } else {
                // Remove status display if no MAWB selected
                const statusDiv = document.getElementById('mawbStatusDetails');
                if (statusDiv) {
                    statusDiv.remove();
                }
            }
        });
    </script>
</body>

</html>