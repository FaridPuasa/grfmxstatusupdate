<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Job</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .result-section {
            display: none;
            margin-top: 20px;
        }

        .table-responsive {
            margin-bottom: 30px;
        }

        .scan-section {
            display: none;
        }

        .scan-active {
            background-color: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 5px;
            padding: 15px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <!-- Initial Header and Form Section -->
        <div id="initialSection">
            <h1 class="mb-4">Update Job</h1>

            <form id="updateJobForm">
                <div class="mb-3">
                    <label for="updateCode" class="form-label">Tracking Status Code / Detail to be updated:</label>
                    <select id="updateCode" name="updateCode" class="form-select" required>
                        <option value="" selected>Please select status</option>
                        <optgroup label="EWE/MGLOBAL/PDU/GDEX Flow">
                            <option value="UAN">1. MAWB Number</option>
                            <option value="CCH">2. On Hold</option>
                        </optgroup>
                        <!-- Other optgroups remain the same -->
                        <optgroup label="Standard Flow">
                            <option value="IIW">1. Item in Warehouse</option>
                            <option value="OFD">2.1. Out for Delivery</option>
                            <option value="OSC">2.2. Self Collect</option>
                        </optgroup>
                        <optgroup label="MGLOBAL Flow">
                            <option value="FCC">1.1. Fail due to Customer not available / cannot be contacted</option>
                            <option value="FIA">1.2. Fail due to Incorrect Address</option>
                            <option value="FSC">1.3.1. Fail due to Reschedule to self collect requested by customer
                            </option>
                            <option value="OSC">1.3.2. Self Collect</option>
                        </optgroup>
                        <optgroup label="After Success/Fail updated on Agent App">
                            <option value="SFJ">Clear Job</option>
                        </optgroup>
                        <optgroup label="Change Details">
                            <option value="OSD">Swap Dispatchers</option>
                            <option value="UWL">Update Warehouse</option>
                            <option value="UGR">Update Go Rush Remark</option>
                            <option value="UJD">Update Job Date</option>
                            <option value="UJM">Update Job Method</option>
                            <option value="UJP">Update Price</option>
                            <option value="UAW">Update Weight</option>
                            <option value="UAS">Update Address</option>
                            <option value="UAR">Update Area</option>
                            <option value="UPN">Update Phone Number</option>
                            <option value="URN">Update Customer Name</option>
                            <option value="UPC">Update Postal Code</option>
                            <option value="UAN">Update MAWB Number</option>
                        </optgroup>
                        <optgroup label="Danger Zone!!!">
                            <option value="UCD">1. Cancelled Job</option>
                            <option value="URJ">2. Cancelled -> Reactivate Job</option>
                            <option value="UDJ">3. Dispose Job</option>
                        </optgroup>
                    </select>
                </div>

                <div id="mawbFields" style="display: none;">
                    <!-- MAWB Number Field -->
                    <div id="mawbNumContainer">
                        <div class="mb-3">
                            <label for="mawbNum" class="form-label">MAWB No: <span id="mawbRequired"
                                    class="text-danger">*</span><span id="mawbOptional" class="text-muted"
                                    style="display:none;"> (Optional)</span></label>
                            <input type="text" id="mawbNum" name="mawbNum" class="form-control">
                            <div class="form-text" id="mawbHelp">Required for MAWB Number update</div>
                        </div>
                    </div>

                    <!-- Warehouse Field -->
                    <div id="warehouseFields" style="display: none;">
                        <div class="mb-3">
                            <label for="warehouse" class="form-label">Warehouse:</label>
                            <select id="warehouse" name="warehouse" class="form-select" required>
                                <option value="" selected>Please select warehouse location</option>
                                <option value="Warehouse K1">Warehouse K1</option>
                                <option value="Warehouse K2">Warehouse K2</option>
                            </select>
                            <div class="warehouse-notes">
                                <small>K1 &gt; Go Rush Kiulap</small><br>
                                <small>K2 &gt; Simpang 14-9</small><br>
                                <strong><small>*If no failed job, pick K1</small></strong>
                            </div>
                        </div>
                    </div>

                    <!-- Update Method -->
                    <div class="mb-3">
                        <label for="updateMethod" class="form-label">Update Method:</label>
                        <select id="updateMethod" name="updateMethod" class="form-select" required>
                            <option value="" selected>Please select method</option>
                            <option value="bulk">1. Bulk</option>
                            <option value="onebyone">2. One by one</option>
                        </select>
                    </div>

                    <!-- Bulk Section -->
                    <div id="bulkSection" class="update-section" style="display: none;">
                        <div class="mb-3">
                            <label for="trackingNumBulk" class="form-label">Tracking Number(s):</label>
                            <textarea id="trackingNumBulk" name="trackingNumBulk" class="form-control" rows="2"
                                placeholder="Enter one tracking number per line"></textarea>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button type="submit" id="submitButton" class="btn btn-primary me-md-2">Submit</button>
                        </div>
                    </div>

                    <!-- One by One Section -->
                    <div id="oneByOneSection" class="update-section scan-section" style="display: none;">
                        <div class="mb-3 text-center">
                            <button type="button" id="readyToScan" class="btn btn-success btn-lg">Ready to Scan</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Active Update Section -->
        <div id="activeUpdateSection" style="display: none;">
            <h1 class="mb-4" id="activeUpdateTitle">Update Title</h1>

            <!-- Delayed Jobs Info -->
            <div id="delayedJobsInfo" class="alert alert-info" style="display: none;">
                <h5><i class="fas fa-clock"></i> Delayed Processing</h5>
                <p id="delayedJobsMessage">Some jobs are queued for delayed processing (30 minutes). They will update to
                    "At Warehouse" automatically.</p>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2" id="loadingMessage">Processing... Please wait</p>
            </div>

            <!-- Bulk Results -->
            <div id="bulkResults" class="result-section">
                <h3>Update Results</h3>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-success">
                            <div class="card-body text-center">
                                <h5 class="card-title">Updated Now</h5>
                                <p class="card-text display-4" id="updatedCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title">Queued (5 min)</h5>
                                <p class="card-text display-4" id="delayedCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title">Failed</h5>
                                <p class="card-text display-4" id="failedCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info">
                            <div class="card-body text-center">
                                <h5 class="card-title">Duplicates</h5>
                                <p class="card-text display-4" id="duplicateCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add total count if needed -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card text-white bg-secondary">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Processed</h5>
                                <p class="card-text display-4" id="totalCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Tables -->
                <div id="resultsContainer"></div>

                <!-- Reset Button -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">Reset</button>
                </div>
            </div>

            <!-- One by One Interface -->
            <div id="oneByOneInterface" style="display: none;">
                <div id="scanResults" class="result-section"></div>
                <div class="mb-3">
                    <label for="trackingNumSingle" class="form-label">Scan or Enter Tracking Number:</label>
                    <input type="text" id="trackingNumSingle" name="trackingNumSingle" class="form-control"
                        placeholder="Scan or paste tracking number">
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        // Add these missing global variables at the top of your JavaScript
        let scanResults = {
            successful: [],
            failed: [],
            delayed: [],
            updatedCount: 0,
            notUpdatedCount: 0,
            delayedCount: 0,
            duplicateCount: 0 // Add duplicate count
        };

        let currentJobId = null;
        let pollInterval = null;
        // Simplified JavaScript for handling the form
        // Update the updateCode change event listener

        // GLOBAL TRACKING FOR DUPLICATES - FRONT-END VERSION
        const processedTrackingNumbers = {
            bulk: new Map(),
            onebyone: new Map()
        };

        // Front-end version of trackDuplicate function
        function trackDuplicate(trackingNumber, updateCode, updateMethod = 'bulk') {
            const key = `${updateCode}_${trackingNumber}`;
            const tracker = updateMethod === 'onebyone' ? processedTrackingNumbers.onebyone : processedTrackingNumbers.bulk;

            const now = Date.now();
            const oneHour = 60 * 60 * 1000;

            if (tracker.has(key)) {
                const data = tracker.get(key);

                // Clean old entries
                if (now - data.lastSeen > oneHour) {
                    tracker.delete(key);
                    // Recreate as new entry
                    tracker.set(key, {
                        trackingNumber: trackingNumber,
                        updateCode: updateCode,
                        count: 1,
                        firstSeen: now,
                        lastSeen: now,
                        processed: false,
                        method: updateMethod
                    });
                    return { isDuplicate: false, count: 1 };
                }

                data.count = (data.count || 1) + 1;
                data.lastSeen = now;
                tracker.set(key, data);
                return { isDuplicate: true, count: data.count };
            } else {
                // First time seeing this tracking number
                tracker.set(key, {
                    trackingNumber: trackingNumber,
                    updateCode: updateCode,
                    count: 1,
                    firstSeen: now,
                    lastSeen: now,
                    processed: false,
                    method: updateMethod
                });
                return { isDuplicate: false, count: 1 };
            }
        }

        document.getElementById('updateCode').addEventListener('change', function () {
            const mawbFields = document.getElementById('mawbFields');
            const updateMethod = document.getElementById('updateMethod');
            const mawbRequired = document.getElementById('mawbRequired');
            const mawbOptional = document.getElementById('mawbOptional');
            const mawbHelp = document.getElementById('mawbHelp');
            const warehouseFields = document.getElementById('warehouseFields');
            const warehouseSelect = document.getElementById('warehouse');
            const mawbNumContainer = document.getElementById('mawbNumContainer');

            if (this.value === 'UAN' || this.value === 'CCH' || this.value === 'IIW') {
                mawbFields.style.display = 'block';
                updateMethod.required = true;

                if (this.value === 'UAN') {
                    // MAWB Update - MAWB required, warehouse not required
                    mawbNumContainer.style.display = 'block';
                    mawbRequired.style.display = 'inline';
                    mawbOptional.style.display = 'none';
                    warehouseFields.style.display = 'none';
                    document.getElementById('mawbNum').required = true;
                    warehouseSelect.required = false;
                    mawbHelp.textContent = 'Required for MAWB Number update';
                } else if (this.value === 'CCH') {
                    // On Hold - No MAWB needed, hide MAWB field completely
                    mawbNumContainer.style.display = 'none'; // HIDE MAWB FIELD
                    warehouseFields.style.display = 'none';
                    document.getElementById('mawbNum').required = false;
                    warehouseSelect.required = false;
                    mawbHelp.textContent = 'No MAWB number required for On Hold';
                } else if (this.value === 'IIW') {
                    // Item in Warehouse - MAWB optional, warehouse required
                    mawbNumContainer.style.display = 'block';
                    mawbRequired.style.display = 'none';
                    mawbOptional.style.display = 'inline';
                    warehouseFields.style.display = 'block';
                    document.getElementById('mawbNum').required = false;
                    warehouseSelect.required = true;
                    mawbHelp.textContent = 'Optional for Item in Warehouse update';
                }
            } else {
                mawbFields.style.display = 'none';
                warehouseSelect.required = false;
                hideAllSections();
            }
        });

        document.getElementById('updateMethod').addEventListener('change', function () {
            hideAllSections();
            if (this.value === 'bulk') {
                document.getElementById('bulkSection').style.display = 'block';
            } else if (this.value === 'onebyone') {
                document.getElementById('oneByOneSection').style.display = 'block';
            }
        });

        document.getElementById('readyToScan').addEventListener('click', function () {
            const updateCode = document.getElementById('updateCode').value;
            const warehouse = document.getElementById('warehouse').value;

            if (updateCode === 'IIW' && !warehouse) {
                alert('Please select a warehouse location');
                return;
            }

            switchToActiveUpdateMode(updateCode, 'onebyone');
        });

        // Update the one-by-one scanning - FIX the duplicate handling
        // Update the one-by-one scanning event listener
        document.getElementById('trackingNumSingle').addEventListener('change', async function () {
            const trackingNumber = this.value.trim();
            if (!trackingNumber) return;

            const updateCode = document.getElementById('updateCode').value;
            const warehouse = document.getElementById('warehouse') ? document.getElementById('warehouse').value : '';
            const mawbNum = document.getElementById('mawbNum') ? document.getElementById('mawbNum').value.trim() : '';

            // FIRST, clear the input field so user can scan again
            this.value = '';

            // Check for duplicate in one-by-one mode
            const duplicateCheck = trackDuplicate(trackingNumber, updateCode, 'onebyone');

            if (duplicateCheck.isDuplicate && duplicateCheck.count > 1) {
                // This is a duplicate - show message but DON'T block
                console.log(`⏭️ Duplicate one-by-one: ${trackingNumber} (seen ${duplicateCheck.count} times)`);

                // Add to scanResults as duplicate
                scanResults.duplicateCount = (scanResults.duplicateCount || 0) + 1;

                // Update display to show duplicate immediately
                updateScanResultsDisplayWithDuplicate(trackingNumber, duplicateCheck.count);

                // Focus for next scan
                setTimeout(() => {
                    this.focus();
                }, 100);
                return; // Exit early since it's a duplicate
            }

            // Validation (only check if not a duplicate)
            if (updateCode === 'UAN' && !mawbNum) {
                alert('Please enter MAWB Number');
                setTimeout(() => {
                    this.focus();
                }, 100);
                return;
            }

            if (updateCode === 'IIW' && !warehouse) {
                alert('Please select a warehouse location');
                setTimeout(() => {
                    this.focus();
                }, 100);
                return;
            }

            showSingleLoading(true);

            try {
                console.log('Sending one-by-one update request...');

                const requestBody = {
                    updateCode: updateCode,
                    trackingNumbers: [trackingNumber],
                    updateMethod: 'onebyone'
                };

                // Add MAWB number for UAN updates
                if (updateCode === 'UAN' && mawbNum) {
                    requestBody.mawbNum = mawbNum;
                }

                // Add warehouse for IIW updates
                if (updateCode === 'IIW' && warehouse) {
                    requestBody.warehouse = warehouse;
                }

                const response = await fetch('/updateJob', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('One-by-one result:', result);

                // Handle the result properly
                if (result.successful && result.successful.length > 0) {
                    scanResults.successful.push(...result.successful);
                    scanResults.updatedCount += result.updatedCount || 0;
                }
                if (result.failed && result.failed.length > 0) {
                    scanResults.failed.push(...result.failed);
                    scanResults.notUpdatedCount += result.failedCount || result.failed.length || 0;
                }
                if (result.delayed && result.delayed.length > 0) {
                    scanResults.delayed.push(...result.delayed);
                    scanResults.delayedCount += result.delayedCount || result.delayed.length || 0;
                }
                if (result.duplicate && result.duplicate.length > 0) {
                    scanResults.duplicateCount = (scanResults.duplicateCount || 0) + (result.duplicateCount || 0);
                }

                updateScanResultsDisplay();

            } catch (error) {
                console.error('Error:', error);
                // Add to failed results
                scanResults.failed.push({
                    trackingNumber: trackingNumber,
                    result: 'Error: ' + error.message
                });
                scanResults.notUpdatedCount++;
                updateScanResultsDisplay();
            } finally {
                showSingleLoading(false);

                // Auto-focus for next scan with slight delay
                setTimeout(() => {
                    this.focus();
                }, 100);
            }
        });

        // Make sure this function properly updates the display
        function updateScanResultsDisplayWithDuplicate(trackingNumber, duplicateCount) {
            const scanResultsDiv = document.getElementById('scanResults');
            if (!scanResultsDiv) {
                console.error('scanResults element not found');
                return;
            }

            // Check if we need to create the results section
            if (scanResultsDiv.style.display === 'none' || scanResultsDiv.innerHTML === '') {
                // Initialize with basic structure
                scanResultsDiv.innerHTML = `
            <h3>Scanning Results</h3>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <h5 class="card-title">Updated</h5>
                            <p class="card-text display-4">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body text-center">
                            <h5 class="card-title">Failed</h5>
                            <p class="card-text display-4">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body text-center">
                            <h5 class="card-title">Delayed</h5>
                            <p class="card-text display-4">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <h5 class="card-title">Duplicates</h5>
                            <p class="card-text display-4" id="duplicateCountDisplay">1</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
                scanResultsDiv.style.display = 'block';
            } else {
                // Update duplicate count
                const duplicateCountElem = scanResultsDiv.querySelector('#duplicateCountDisplay') ||
                    scanResultsDiv.querySelector('.bg-info .display-4');
                if (duplicateCountElem) {
                    const currentCount = parseInt(duplicateCountElem.textContent) || 0;
                    duplicateCountElem.textContent = currentCount + 1;
                }
            }

            // Add duplicate alert at the top
            let currentHtml = scanResultsDiv.innerHTML;

            const duplicateAlert = `
        <div class="alert alert-info alert-dismissible fade show">
            <strong>⚠️ Duplicate:</strong> 
            ${trackingNumber} - Skipped (seen ${duplicateCount} times)
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

            // Insert at the beginning (after the title if exists)
            const titleIndex = currentHtml.indexOf('<h3>Scanning Results</h3>');
            if (titleIndex !== -1) {
                const afterTitle = currentHtml.indexOf('</h3>', titleIndex) + 5;
                scanResultsDiv.innerHTML = currentHtml.substring(0, afterTitle) + duplicateAlert + currentHtml.substring(afterTitle);
            } else {
                scanResultsDiv.innerHTML = duplicateAlert + currentHtml;
            }

            scanResultsDiv.scrollTop = 0;
        }

        // Update updateScanResultsDisplay to include duplicates
        function updateScanResultsDisplay() {
            const scanResultsDiv = document.getElementById('scanResults');
            if (!scanResultsDiv) {
                console.error('scanResults element not found');
                return;
            }

            let html = `
        <h3>Scanning Results</h3>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Updated</h5>
                        <p class="card-text display-4">${scanResults.updatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                        <h5 class="card-title">Failed</h5>
                        <p class="card-text display-4">${scanResults.notUpdatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">Delayed</h5>
                        <p class="card-text display-4">${scanResults.delayedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">Duplicates</h5>
                        <p class="card-text display-4">${scanResults.duplicateCount || 0}</p>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Show latest result at the top
            const allResults = [...scanResults.successful, ...scanResults.failed, ...scanResults.delayed];
            const latestResult = allResults[allResults.length - 1];

            if (latestResult) {
                const isSuccess = scanResults.successful.includes(latestResult);
                const isDelayed = scanResults.delayed.includes(latestResult);

                let alertClass = 'alert-danger';
                let icon = '❌';
                let status = 'Failed';

                if (isSuccess) {
                    alertClass = 'alert-success';
                    icon = '✅';
                    status = 'Success';
                } else if (isDelayed) {
                    alertClass = 'alert-warning';
                    icon = '⏰';
                    status = 'Delayed';
                }

                html += `
            <div class="alert ${alertClass} alert-dismissible fade show">
                <strong>${icon} ${status}:</strong> 
                ${latestResult.trackingNumber} - ${latestResult.result || 'No result message'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
            }

            // Add successful jobs table if any
            if (scanResults.successful.length > 0) {
                const recentSuccessful = scanResults.successful.slice(-10).reverse();
                html += `
            <h4 class="text-success">Recently Updated</h4>
            <div class="table-responsive mb-3">
                <table class="table table-success table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentSuccessful.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Updated'}</small></td>
                                <td><small><span class="badge bg-success">Success</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // Add duplicate jobs table if any duplicates
            if (scanResults.duplicateCount > 0) {
                html += `
            <h4 class="text-info">Duplicates Skipped</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Duplicate tracking numbers were skipped and not processed again.
            </div>
            <div class="table-responsive mb-3">
                <table class="table table-info table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Duplicate Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="duplicateTableBody">
                        ${getRecentDuplicates().map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.count || 1}</small></td>
                                <td><small><span class="badge bg-info">Duplicate</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // Add delayed jobs table if any
            if (scanResults.delayed.length > 0) {
                const recentDelayed = scanResults.delayed.slice(-10).reverse();
                html += `
            <h4 class="text-warning">Recently Delayed</h4>
            <div class="table-responsive mb-3">
                <table class="table table-warning table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Scheduled Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentDelayed.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.scheduledTime || '5 mins delay for testing'}</small></td>
                                <td><small><span class="badge bg-warning">Scheduled</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // Add failed jobs table if any
            if (scanResults.failed.length > 0) {
                const recentFailed = scanResults.failed.slice(-10).reverse();
                html += `
            <h4 class="text-danger">Recent Failures</h4>
            <div class="table-responsive">
                <table class="table table-danger table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentFailed.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Failed'}</small></td>
                                <td><small><span class="badge bg-danger">Failed</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            scanResultsDiv.innerHTML = html;
            scanResultsDiv.style.display = 'block';
            scanResultsDiv.scrollTop = scanResultsDiv.scrollHeight;
        }

        // Helper function to get recent duplicates
        function getRecentDuplicates() {
            const duplicates = [];
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();

            // Check both bulk and onebyone trackers
            for (const [key, data] of processedTrackingNumbers.onebyone.entries()) {
                if (data.count > 1 && (now - data.lastSeen) < oneHour) {
                    duplicates.push({
                        trackingNumber: data.trackingNumber,
                        count: data.count,
                        updateCode: data.updateCode,
                        lastSeen: new Date(data.lastSeen).toLocaleTimeString()
                    });
                }
            }

            return duplicates.slice(-10).reverse(); // Return last 10 duplicates
        }

        // Update form submission - no alert for duplicates
        document.getElementById('updateJobForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const updateCode = document.getElementById('updateCode').value;
            const mawbNum = document.getElementById('mawbNum') ? document.getElementById('mawbNum').value.trim() : '';
            const warehouse = document.getElementById('warehouse') ? document.getElementById('warehouse').value : '';
            const updateMethod = document.getElementById('updateMethod') ? document.getElementById('updateMethod').value : 'bulk';

            let trackingNumbers = [];

            // Get tracking numbers
            if (updateMethod === 'bulk') {
                const trackingNumBulk = document.getElementById('trackingNumBulk').value;
                trackingNumbers = trackingNumBulk.split('\n').map(num => num.trim()).filter(num => num !== '');
            } else {
                return; // One-by-one handled separately
            }

            if (trackingNumbers.length === 0) {
                alert('Please enter tracking numbers');
                return;
            }

            // Count duplicates (for logging only)
            const trackingCounts = {};
            trackingNumbers.forEach(num => {
                trackingCounts[num] = (trackingCounts[num] || 0) + 1;
            });

            const duplicateEntries = Object.entries(trackingCounts)
                .filter(([num, count]) => count > 1);

            if (duplicateEntries.length > 0) {
                console.log(`Found ${duplicateEntries.length} duplicate tracking number(s) in input`);
            }

            // Validation for different update codes
            if (updateCode === 'UAN') {
                if (!mawbNum || mawbNum === '') {
                    alert('Please enter MAWB Number');
                    return;
                }
            } else if (updateCode === 'IIW') {
                if (!warehouse) {
                    alert('Please select a warehouse location');
                    return;
                }
            }

            // Check if it's a large batch
            const LARGE_BATCH_THRESHOLD = 300;

            if (trackingNumbers.length > LARGE_BATCH_THRESHOLD) {
                // Use chunked processing for large batches
                processLargeBatchInChunks(trackingNumbers, updateCode, mawbNum, warehouse);
            } else {
                // Use normal processing for smaller batches
                processNormalBatch(trackingNumbers, updateCode, mawbNum, warehouse, updateMethod);
            }
        });

        // Replace the displayBulkResults function with this updated version
        function displayBulkResults(result) {
            const bulkResults = document.getElementById('bulkResults');
            if (!bulkResults) {
                console.error('bulkResults element not found');
                return;
            }

            bulkResults.style.display = 'block';

            // Update all counts - FIXED: Ensure duplicate count is displayed
            const updatedCountElem = document.getElementById('updatedCount');
            const failedCountElem = document.getElementById('failedCount');
            const delayedCountElem = document.getElementById('delayedCount');
            const totalCountElem = document.getElementById('totalCount');
            const duplicateCountElem = document.getElementById('duplicateCount');

            if (updatedCountElem) updatedCountElem.textContent = result.updatedCount || 0;
            if (failedCountElem) failedCountElem.textContent = result.failedCount || result.notUpdatedCount || 0;
            if (delayedCountElem) delayedCountElem.textContent = result.delayedCount || 0;
            if (totalCountElem) totalCountElem.textContent = result.total || result.totalJobs || result.updatedCount + result.failedCount + result.delayedCount + result.duplicateCount || 0;
            if (duplicateCountElem) duplicateCountElem.textContent = result.duplicateCount || 0;

            // Clear previous results container
            const resultsContainer = document.getElementById('resultsContainer');
            if (!resultsContainer) {
                console.error('resultsContainer element not found');
                return;
            }

            resultsContainer.innerHTML = '';

            // Show delayed jobs info
            if (result.delayed && result.delayed.length > 0) {
                const delayedJobsInfo = document.getElementById('delayedJobsInfo');
                if (delayedJobsInfo) {
                    delayedJobsInfo.style.display = 'block';
                    const message = document.getElementById('delayedJobsMessage');
                    if (message) {
                        message.textContent = `${result.delayedCount || result.delayed.length} job(s) are queued for delayed processing (5 minutes for testing). They will update to "At Warehouse" automatically.`;
                    }
                }
            }

            // Create successful table if there are successful updates
            if (result.successful && result.successful.length > 0) {
                const successTable = document.createElement('div');
                successTable.innerHTML = `
            <h4 class="text-success mt-4">Successfully Updated Jobs (${result.successful.length})</h4>
            <div class="table-responsive">
                <table class="table table-success table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="successTableBody">
                        ${result.successful.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.result || 'Updated'}</td>
                                <td><span class="badge bg-success">Completed</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
                resultsContainer.appendChild(successTable);
            }

            // Create duplicate table if there are duplicates
            if (result.duplicate && result.duplicate.length > 0) {
                const duplicateTable = document.createElement('div');
                duplicateTable.innerHTML = `
            <h4 class="text-info mt-4">Duplicate Jobs (Ignored) (${result.duplicate.length})</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Duplicate tracking numbers were ignored and not processed again.
            </div>
            <div class="table-responsive">
                <table class="table table-info table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Duplicate Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="duplicateTableBody">
                        ${result.duplicate.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.duplicateCount || 1}</td>
                                <td><span class="badge bg-info">Ignored</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
                resultsContainer.appendChild(duplicateTable);
            }

            // Create delayed table if there are delayed jobs
            if (result.delayed && result.delayed.length > 0) {
                const delayedTable = document.createElement('div');
                delayedTable.innerHTML = `
            <h4 class="text-warning mt-4">Delayed Jobs (5-minute wait for testing) (${result.delayed.length})</h4>
            <div class="table-responsive">
                <table class="table table-warning table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Product</th>
                            <th>Scheduled Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="delayedTableBody">
                        ${result.delayed.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.product || 'Unknown'}</td>
                                <td>${item.scheduledTime || '5 minutes delay for testing'}</td>
                                <td><span class="badge bg-warning">Scheduled</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
                resultsContainer.appendChild(delayedTable);
            }

            // Create failed table if there are failed updates
            if (result.failed && result.failed.length > 0) {
                const failedTable = document.createElement('div');
                failedTable.innerHTML = `
            <h4 class="text-danger mt-4">Failed Jobs (${result.failed.length})</h4>
            <div class="table-responsive">
                <table class="table table-danger table-striped">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="failedTableBody">
                        ${result.failed.map(item => `
                            <tr>
                                <td>${item.trackingNumber || 'N/A'}</td>
                                <td>${item.result || 'Failed'}</td>
                                <td><span class="badge bg-danger">Failed</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
                resultsContainer.appendChild(failedTable);
            }

            // If no results at all, show a message
            if ((!result.successful || result.successful.length === 0) &&
                (!result.duplicate || result.duplicate.length === 0) &&
                (!result.delayed || result.delayed.length === 0) &&
                (!result.failed || result.failed.length === 0)) {
                const noResults = document.createElement('div');
                noResults.className = 'alert alert-info';
                noResults.innerHTML = '<strong>No results to display.</strong>';
                resultsContainer.appendChild(noResults);
            }

            // Auto-scroll to results
            setTimeout(() => {
                bulkResults.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Also make sure this function is defined at the top level
        function getUpdateTitle(updateCode) {
            const updateTitles = {
                'UAN': 'MAWB Number Update',
                'CCH': 'On Hold Update',
                'IIW': 'Item in Warehouse Update',
                'OFD': 'Out for Delivery Update',
                'OSC': 'Self Collect Update',
                'FCC': 'Customer Not Available Update',
                'FIA': 'Incorrect Address Update',
                'FSC': 'Reschedule to Self Collect Update',
                'SFJ': 'Clear Job Update',
                'OSD': 'Swap Dispatchers Update',
                'UWL': 'Update Warehouse',
                'UGR': 'Update Go Rush Remark',
                'UJD': 'Update Job Date',
                'UJM': 'Update Job Method',
                'UJP': 'Update Price',
                'UAW': 'Update Weight',
                'UAS': 'Update Address',
                'UAR': 'Update Area',
                'UPN': 'Update Phone Number',
                'URN': 'Update Customer Name',
                'UPC': 'Update Postal Code',
                'UAB': 'Update AWB Number',
                'UCD': 'Cancelled Job Update',
                'URJ': 'Reactivate Job Update',
                'UDJ': 'Dispose Job Update'
            };

            return updateTitles[updateCode] || 'Update Job';
        }

        // Function to process large batches in chunks - UPDATED
        async function processLargeBatchInChunks(trackingNumbers, updateCode, mawbNum, warehouse) { // ADD warehouse parameter
            const CHUNK_SIZE = 200; // Process 200 items per chunk
            const chunks = [];

            // Split into chunks
            for (let i = 0; i < trackingNumbers.length; i += CHUNK_SIZE) {
                chunks.push(trackingNumbers.slice(i, i + CHUNK_SIZE));
            }

            // Show chunk processing UI
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('activeUpdateSection').style.display = 'block';
            document.getElementById('activeUpdateTitle').textContent = getUpdateTitle(updateCode) + ' (Chunked Processing)';
            document.getElementById('bulkResults').style.display = 'none';
            document.getElementById('oneByOneInterface').style.display = 'none';

            // Create chunk processing UI
            document.getElementById('loading').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Processing Large Batch</h4>
            <p>Total: ${trackingNumbers.length} items in ${chunks.length} chunks</p>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Overall Progress</h6>
                            <div class="progress" style="height: 25px;">
                                <div id="overallProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                            </div>
                            <small id="overallText">Starting...</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Current Chunk</h6>
                            <div class="progress" style="height: 25px;">
                                <div id="chunkProgress" class="progress-bar progress-bar-info progress-bar-striped" 
                                     role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                            </div>
                            <small id="chunkText">Chunk 0/${chunks.length}</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <h6>Total Updated</h6>
                            <h3 id="totalUpdated">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-danger">
                        <div class="card-body text-center">
                            <h6>Total Failed</h6>
                            <h3 id="totalFailed">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <h6>Current Chunk</h6>
                            <h3 id="currentChunkDisplay">1/${chunks.length}</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-warning" onclick="cancelChunkedProcessing()">Cancel Processing</button>
            </div>
        </div>
    `;
            document.getElementById('loading').style.display = 'block';

            // Initialize results
            const chunkedResults = {
                successful: [],
                failed: [],
                updatedCount: 0,
                notUpdatedCount: 0,
                completedChunks: 0,
                totalChunks: chunks.length,
                isCancelled: false
            };

            // Store globally for cancellation
            window.chunkedProcessing = {
                results: chunkedResults,
                isProcessing: true
            };

            // Process chunks sequentially with delay
            for (let i = 0; i < chunks.length; i++) {
                if (window.chunkedProcessing.isCancelled) break;

                // Update UI for current chunk
                document.getElementById('currentChunkDisplay').textContent = `${i + 1}/${chunks.length}`;
                document.getElementById('chunkProgress').style.width = `${((i + 1) / chunks.length) * 100}%`;
                document.getElementById('chunkProgress').textContent = `${Math.round(((i + 1) / chunks.length) * 100)}%`;
                document.getElementById('chunkText').textContent = `Processing chunk ${i + 1}/${chunks.length}`;

                try {
                    // Process this chunk - PASS warehouse parameter
                    const chunkResult = await processChunk(chunks[i], updateCode, mawbNum, warehouse, i); // ADD warehouse parameter

                    // Merge results
                    chunkedResults.successful.push(...chunkResult.successful);
                    chunkedResults.failed.push(...chunkResult.failed);
                    chunkedResults.updatedCount += chunkResult.updatedCount;
                    chunkedResults.notUpdatedCount += chunkResult.notUpdatedCount;
                    chunkedResults.completedChunks = i + 1;

                    // Update overall progress
                    const overallProgress = ((i + 1) / chunks.length) * 100;
                    document.getElementById('overallProgress').style.width = `${overallProgress}%`;
                    document.getElementById('overallProgress').textContent = `${Math.round(overallProgress)}%`;
                    document.getElementById('overallText').textContent =
                        `${chunkedResults.updatedCount} updated, ${chunkedResults.notUpdatedCount} failed`;

                    document.getElementById('totalUpdated').textContent = chunkedResults.updatedCount;
                    document.getElementById('totalFailed').textContent = chunkedResults.notUpdatedCount;

                    // Delay between chunks (except last one)
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay
                    }

                } catch (error) {
                    console.error(`Error processing chunk ${i + 1}:`, error);
                    // Add chunk to failed
                    chunks[i].forEach(trackingNumber => {
                        chunkedResults.failed.push({
                            trackingNumber: trackingNumber,
                            result: 'Chunk processing error'
                        });
                        chunkedResults.notUpdatedCount++;
                    });
                }
            }

            // Processing complete
            if (!window.chunkedProcessing.isCancelled) {
                document.getElementById('loading').style.display = 'none';
                displayBulkResults(chunkedResults);

                setTimeout(() => {
                    alert(`✅ Large batch processing completed!\n\nSuccessfully updated: ${chunkedResults.updatedCount}\nFailed: ${chunkedResults.notUpdatedCount}\nProcessed in ${chunks.length} chunks`);
                }, 500);
            }

            window.chunkedProcessing.isProcessing = false;
        }

        // Function to process a single chunk - UPDATED
        async function processChunk(chunk, updateCode, mawbNum, warehouse, chunkIndex) { // ADD warehouse parameter
            try {
                const requestBody = {
                    updateCode: updateCode,
                    trackingNumbers: chunk,
                    updateMethod: 'bulk',
                    chunkIndex: chunkIndex
                };

                if (updateCode === 'UAN' && mawbNum) {
                    requestBody.mawbNum = mawbNum;
                }

                if (updateCode === 'IIW' && warehouse) { // ADD warehouse for IIW
                    requestBody.warehouse = warehouse;
                }

                const response = await fetch('/updateJob/chunk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.jobId) {
                    // Wait for chunk to complete
                    return await waitForChunkCompletion(result.jobId);
                } else {
                    // Direct result
                    return result;
                }

            } catch (error) {
                console.error('Chunk processing error:', error);
                throw error;
            }
        }

        // Wait for chunk job to complete
        async function waitForChunkCompletion(jobId) {
            const maxAttempts = 60; // 2 minutes max
            let attempts = 0;

            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(async () => {
                    attempts++;

                    try {
                        const response = await fetch(`/updateJob/status/${jobId}`);
                        const jobStatus = await response.json();

                        if (jobStatus.status === 'completed') {
                            clearInterval(checkInterval);
                            resolve(jobStatus);
                        } else if (jobStatus.status === 'failed' || attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(new Error('Chunk processing timeout or failed'));
                        }
                    } catch (error) {
                        console.error('Error checking chunk status:', error);
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(error);
                        }
                    }
                }, 2000); // Check every 2 seconds
            });
        }

        // Cancel chunked processing
        function cancelChunkedProcessing() {
            if (window.chunkedProcessing) {
                window.chunkedProcessing.isCancelled = true;
                alert('Processing cancelled. Partial results will be shown.');

                // Show partial results
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    displayBulkResults(window.chunkedProcessing.results);
                }, 500);
            }
        }

        // Normal batch processing - UPDATED
        async function processNormalBatch(trackingNumbers, updateCode, mawbNum, warehouse, updateMethod) { // ADD warehouse parameter
            // Switch to active update mode
            switchToActiveUpdateMode(updateCode, 'bulk');

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Starting processing...</p>
        <div class="progress mt-3" style="height: 25px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
        </div>
        <p id="progressText" class="mt-2">Initializing...</p>
        <p class="text-muted small">Processing ${trackingNumbers.length} jobs...</p>
    `;

            document.getElementById('bulkResults').style.display = 'none';

            try {
                const requestBody = {
                    updateCode: updateCode,
                    trackingNumbers: trackingNumbers,
                    updateMethod: 'bulk'
                };

                if (updateCode === 'UAN' && mawbNum) {
                    requestBody.mawbNum = mawbNum;
                }

                if (updateCode === 'IIW' && warehouse) { // ADD warehouse for IIW
                    requestBody.warehouse = warehouse;
                }

                const response = await fetch('/updateJob', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.jobId) {
                    currentJobId = result.jobId;
                    startPollingResults();
                } else {
                    throw new Error('No job ID received for processing');
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                alert('An error occurred while starting the job: ' + error.message);
            }
        }
        // HELPER FUNCTIONS

        function hideAllSections() {
            document.getElementById('bulkSection').style.display = 'none';
            document.getElementById('oneByOneSection').style.display = 'none';
        }

        function showSingleLoading(show) {
            const input = document.getElementById('trackingNumSingle');
            const loadingDiv = document.getElementById('loading');

            if (show) {
                input.disabled = true;
                input.placeholder = 'Processing...';
                input.style.backgroundColor = '#fff3cd';

                // Show minimal loading for single items
                loadingDiv.style.display = 'block';
                loadingDiv.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Updating...</span>
            `;
            } else {
                input.disabled = false;
                input.placeholder = 'Scan or paste tracking number';
                input.style.backgroundColor = '';
                loadingDiv.style.display = 'none';
            }
        }

        async function waitForJobCompletion(jobId, trackingNumber) {
            const maxAttempts = 30;
            let attempts = 0;

            return new Promise((resolve) => {
                const checkInterval = setInterval(async () => {
                    attempts++;

                    try {
                        const response = await fetch(`/updateJob/status/${jobId}`);
                        const jobStatus = await response.json();

                        if (jobStatus.status === 'completed') {
                            clearInterval(checkInterval);

                            // Update scan results
                            if (jobStatus.successful && jobStatus.successful.length > 0) {
                                scanResults.successful.push(...jobStatus.successful);
                                scanResults.updatedCount += jobStatus.updatedCount;
                            }
                            if (jobStatus.failed && jobStatus.failed.length > 0) {
                                scanResults.failed.push(...jobStatus.failed);
                                scanResults.notUpdatedCount += jobStatus.notUpdatedCount;
                            }

                            updateScanResultsDisplay();
                            resolve();
                        } else if (jobStatus.status === 'failed' || attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            scanResults.failed.push({
                                trackingNumber: trackingNumber,
                                result: 'Processing timeout or failed'
                            });
                            scanResults.notUpdatedCount++;
                            updateScanResultsDisplay();
                            resolve();
                        }
                    } catch (error) {
                        console.error('Error checking job status:', error);
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }
                }, 2000);
            });
        }

        // Replace the existing startPollingResults function with this updated version
        function startPollingResults() {
            const startTime = Date.now();
            let lastProgressUpdate = 0;

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/updateJob/status/${currentJobId}`);
                    const jobStatus = await response.json();

                    // Update progress with better estimation
                    if (jobStatus.status === 'processing' || jobStatus.status === 'queued') {
                        const currentTime = Date.now();

                        // Update progress bar
                        const progress = jobStatus.total > 0 ? Math.round((jobStatus.processed / jobStatus.total) * 100) : 0;
                        const progressBar = document.getElementById('progressBar');
                        const progressText = document.getElementById('progressText');

                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${progress}%`;
                        }

                        // Only update text every 2 seconds to avoid flickering
                        if (currentTime - lastProgressUpdate > 2000 && progressText) {
                            lastProgressUpdate = currentTime;

                            const elapsedSeconds = (currentTime - startTime) / 1000;
                            let progressTextHtml = `Processed ${jobStatus.processed} of ${jobStatus.total} jobs`;

                            // Add estimated time if we have meaningful progress
                            if (jobStatus.processed > 0 && elapsedSeconds > 5) {
                                const itemsPerSecond = jobStatus.processed / elapsedSeconds;
                                const remainingItems = jobStatus.total - jobStatus.processed;
                                const estimatedSeconds = remainingItems / itemsPerSecond;

                                if (estimatedSeconds > 0) {
                                    if (estimatedSeconds > 60) {
                                        const minutes = Math.floor(estimatedSeconds / 60);
                                        const seconds = Math.round(estimatedSeconds % 60);
                                        progressTextHtml += `<br>Estimated time remaining: ${minutes}min ${seconds}s`;
                                    } else {
                                        progressTextHtml += `<br>Estimated time remaining: ${Math.round(estimatedSeconds)}s`;
                                    }
                                    progressTextHtml += ` (${itemsPerSecond.toFixed(1)} items/sec)`;
                                }

                                // Show batch info if available
                                if (jobStatus.currentBatch && jobStatus.totalBatches) {
                                    progressTextHtml += `<br>Batch: ${jobStatus.currentBatch}/${jobStatus.totalBatches}`;
                                }
                            }

                            if (progressText) {
                                progressText.innerHTML = progressTextHtml;
                            }
                        }
                    }

                    // Check if job is completed
                    if (jobStatus.status === 'completed') {
                        clearInterval(pollInterval);
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';

                        // Check if displayBulkResults function exists before calling it
                        if (typeof displayBulkResults === 'function') {
                            displayBulkResults(jobStatus);
                        } else {
                            console.error('displayBulkResults function is not defined');
                            // Fallback: reload the page to show results
                            location.reload();
                        }

                        // Show completion time
                        const totalSeconds = ((Date.now() - startTime) / 1000).toFixed(1);
                        setTimeout(() => {
                            alert(`✅ Processing completed in ${totalSeconds} seconds!\n\nSuccessfully updated: ${jobStatus.updatedCount || 0}\nFailed: ${jobStatus.failedCount || jobStatus.notUpdatedCount || 0}\nDelayed: ${jobStatus.delayedCount || 0}\nDuplicates ignored: ${jobStatus.duplicateCount || 0}`);
                        }, 500);

                    } else if (jobStatus.status === 'failed') {
                        clearInterval(pollInterval);
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';
                        alert('❌ Job failed: ' + (jobStatus.error || 'Unknown error'));
                    }

                } catch (error) {
                    console.error('Error polling job status:', error);

                    // If we keep getting errors, stop polling after a few attempts
                    if (!window.pollErrorCount) {
                        window.pollErrorCount = 1;
                    } else {
                        window.pollErrorCount++;
                    }

                    if (window.pollErrorCount > 5) {
                        clearInterval(pollInterval);
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';
                        alert('❌ Connection error. Please check the results manually.');
                    }
                }
            }, 2000);
        }

        function updateScanResultsDisplay() {
            const scanResultsDiv = document.getElementById('scanResults');
            if (!scanResultsDiv) {
                console.error('scanResults element not found');
                return;
            }

            let html = `
        <h3>Scanning Results</h3>
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Updated</h5>
                        <p class="card-text display-4">${scanResults.updatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                        <h5 class="card-title">Failed</h5>
                        <p class="card-text display-4">${scanResults.notUpdatedCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">Delayed</h5>
                        <p class="card-text display-4">${scanResults.delayedCount}</p>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Show latest result at the top
            const allResults = [...scanResults.successful, ...scanResults.failed, ...scanResults.delayed];
            const latestResult = allResults[allResults.length - 1];

            if (latestResult) {
                const isSuccess = scanResults.successful.includes(latestResult);
                const isDelayed = scanResults.delayed.includes(latestResult);

                let alertClass = 'alert-danger';
                let icon = '❌';
                let status = 'Failed';

                if (isSuccess) {
                    alertClass = 'alert-success';
                    icon = '✅';
                    status = 'Success';
                } else if (isDelayed) {
                    alertClass = 'alert-warning';
                    icon = '⏰';
                    status = 'Delayed';
                }

                html += `
            <div class="alert ${alertClass} alert-dismissible fade show">
                <strong>${icon} ${status}:</strong> 
                ${latestResult.trackingNumber} - ${latestResult.result || 'No result message'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
            }

            // Add successful jobs table if any
            if (scanResults.successful.length > 0) {
                const recentSuccessful = scanResults.successful.slice(-10).reverse();
                html += `
            <h4 class="text-success">Recently Updated</h4>
            <div class="table-responsive mb-3">
                <table class="table table-success table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentSuccessful.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Updated'}</small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // Add delayed jobs table if any
            if (scanResults.delayed.length > 0) {
                const recentDelayed = scanResults.delayed.slice(-10).reverse();
                html += `
            <h4 class="text-warning">Recently Delayed</h4>
            <div class="table-responsive mb-3">
                <table class="table table-warning table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Scheduled Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentDelayed.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.scheduledTime || '30 mins delay'}</small></td>
                                <td><small><span class="badge bg-warning">Scheduled</span></small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            // Add failed jobs table if any
            if (scanResults.failed.length > 0) {
                const recentFailed = scanResults.failed.slice(-10).reverse();
                html += `
            <h4 class="text-danger">Recent Failures</h4>
            <div class="table-responsive">
                <table class="table table-danger table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentFailed.map(item => `
                            <tr>
                                <td><small>${item.trackingNumber || 'N/A'}</small></td>
                                <td><small>${item.result || 'Failed'}</small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }

            scanResultsDiv.innerHTML = html;
            scanResultsDiv.style.display = 'block';
            scanResultsDiv.scrollTop = scanResultsDiv.scrollHeight;
        }

        // Add this function to check and handle duplicates
        function checkAndHandleDuplicate(trackingNumber, updateCode) {
            const key = `${updateCode}_${trackingNumber}`;
            const now = Date.now();

            if (processedTrackingNumbers.has(key)) {
                const lastProcessed = processedTrackingNumbers.get(key);
                const timeDiff = now - lastProcessed.timestamp;

                // Increment duplicate count
                lastProcessed.count = (lastProcessed.count || 1) + 1;
                lastProcessed.timestamp = now;
                processedTrackingNumbers.set(key, lastProcessed);

                console.log(`⚠️ Duplicate tracking number detected: ${trackingNumber} (${updateCode}), count: ${lastProcessed.count}`);
                return {
                    isDuplicate: true,
                    count: lastProcessed.count
                };
            } else {
                // First time processing this tracking number
                processedTrackingNumbers.set(key, {
                    timestamp: now,
                    count: 1
                });
                return {
                    isDuplicate: false,
                    count: 1
                };
            }
        }

        // Clean up old entries (older than 1 hour)
        setInterval(() => {
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();

            // Clean bulk tracker
            for (const [key, data] of processedTrackingNumbers.bulk.entries()) {
                if (now - data.lastSeen > oneHour) {
                    processedTrackingNumbers.bulk.delete(key);
                }
            }

            // Clean onebyone tracker
            for (const [key, data] of processedTrackingNumbers.onebyone.entries()) {
                if (now - data.lastSeen > oneHour) {
                    processedTrackingNumbers.onebyone.delete(key);
                }
            }

            console.log(`🧹 Front-end cleanup: Bulk: ${processedTrackingNumbers.bulk.size}, OneByOne: ${processedTrackingNumbers.onebyone.size}`);
        }, 5 * 60 * 1000); // Run every 5 minutes

        // Update the processSingleTrackingNumber function to handle duplicates
        async function processSingleTrackingNumber(trackingNumber, updateCode, mawbNum, warehouse, req) {
            const cleanTrackingNumber = trackingNumber.trim();

            if (!cleanTrackingNumber) {
                return { success: false, error: 'Empty tracking number', isDuplicate: false };
            }

            // Check for duplicate
            const duplicateCheck = checkAndHandleDuplicate(cleanTrackingNumber, updateCode);
            if (duplicateCheck.isDuplicate && duplicateCheck.count > 1) {
                return {
                    success: false,
                    error: `Duplicate tracking number (count: ${duplicateCheck.count})`,
                    trackingNumber: cleanTrackingNumber,
                    isDuplicate: true,
                    duplicateCount: duplicateCheck.count
                };
            }

            try {
                console.log(`🔍 Processing ${cleanTrackingNumber} with updateCode: ${updateCode}`);

                let processSuccess = false;
                let message = '';

                switch (updateCode) {
                    case 'UAN':
                        processSuccess = await processMAWBUpdate(cleanTrackingNumber, mawbNum, req);
                        message = processSuccess ? `MAWB Number updated to ${mawbNum}` : 'MAWB update failed';
                        break;
                    case 'CCH':
                        processSuccess = await processOnHoldUpdate(cleanTrackingNumber, req);
                        message = processSuccess ? 'Job put on hold' : 'On hold update failed';
                        break;
                    case 'IIW':
                        const result = await processItemInWarehouseUpdate(cleanTrackingNumber, warehouse, req);
                        processSuccess = result.success;
                        message = result.message;
                        break;
                    default:
                        console.log(`⚠️ Generic update called for ${updateCode}`);
                        processSuccess = await processGenericUpdate(cleanTrackingNumber, updateCode, req, mawbNum);
                        message = processSuccess ? `Updated with ${updateCode}` : `${updateCode} update failed`;
                }

                console.log(`📊 Result for ${cleanTrackingNumber}: ${processSuccess ? 'SUCCESS' : 'FAILED'} - ${message}`);

                return {
                    success: processSuccess,
                    message: message,
                    trackingNumber: cleanTrackingNumber,
                    isDuplicate: false,
                    duplicateCount: 1
                };

            } catch (error) {
                console.error(`❌ Error processing ${cleanTrackingNumber}:`, error);
                return {
                    success: false,
                    error: error.message,
                    trackingNumber: cleanTrackingNumber,
                    isDuplicate: false,
                    duplicateCount: 1
                };
            }
        }

        async function processBatch(batch, updateCode, mawbNum, warehouse, req) {
            console.log(`🔄 Processing batch of ${batch.length} items with updateCode: ${updateCode}`);

            const batchPromises = batch.map(async (trackingNumber) => {
                try {
                    // Check for duplicate
                    const duplicateCheck = trackDuplicate(trackingNumber, updateCode, 'bulk');

                    if (duplicateCheck.isDuplicate && duplicateCheck.count > 1) {
                        // This is a duplicate - skip processing
                        console.log(`⏭️ Skipping duplicate: ${trackingNumber} (seen ${duplicateCheck.count} times)`);
                        return {
                            success: false,
                            message: `Duplicate tracking number (count: ${duplicateCheck.count})`,
                            isDuplicate: true,
                            duplicateCount: duplicateCheck.count
                        };
                    }

                    // Mark as being processed
                    const key = `${updateCode}_${trackingNumber}`;
                    const data = processedTrackingNumbers.bulk.get(key);
                    if (data) {
                        data.processed = true;
                        processedTrackingNumbers.bulk.set(key, data);
                    }

                    // Process the update
                    if (updateCode === 'IIW') {
                        return await processItemInWarehouseUpdate(trackingNumber, warehouse, req);
                    } else if (updateCode === 'UAN') {
                        const success = await processMAWBUpdate(trackingNumber, mawbNum, req);
                        return {
                            success: success,
                            message: success ? `MAWB updated to ${mawbNum}` : 'MAWB update failed'
                        };
                    } else if (updateCode === 'CCH') {
                        const success = await processOnHoldUpdate(trackingNumber, req);
                        return {
                            success: success,
                            message: success ? 'Put on hold' : 'On hold update failed'
                        };
                    } else {
                        return {
                            success: false,
                            message: `Unsupported update code: ${updateCode}`
                        };
                    }
                } catch (error) {
                    console.error(`❌ Error processing ${trackingNumber}:`, error);
                    return {
                        success: false,
                        message: 'Error: ' + error.message
                    };
                }
            });

            const batchResults = await Promise.allSettled(batchPromises);

            // Process results
            const results = {
                successful: [],
                failed: [],
                delayed: [],
                duplicate: [],
                updatedCount: 0,
                failedCount: 0,
                delayedCount: 0,
                duplicateCount: 0
            };

            batchResults.forEach((result, index) => {
                const trackingNumber = batch[index];

                if (result.status === 'fulfilled' && result.value) {
                    const value = result.value;

                    if (value.isDuplicate) {
                        results.duplicate.push({
                            trackingNumber: trackingNumber,
                            result: value.message || 'Duplicate tracking number',
                            duplicateCount: value.duplicateCount || 1,
                            status: "Duplicate"
                        });
                        results.duplicateCount++;
                    } else if (value.delayed) {
                        results.delayed.push({
                            trackingNumber: trackingNumber,
                            result: value.message,
                            product: value.delayedInfo?.product,
                            scheduledTime: value.delayedInfo?.scheduledTime,
                            currentStatus: value.delayedInfo?.currentStatus,
                            status: "Queued (5 min)"
                        });
                        results.delayedCount++;
                    } else if (value.success) {
                        results.successful.push({
                            trackingNumber: trackingNumber,
                            result: value.message,
                            status: "Updated"
                        });
                        results.updatedCount++;
                    } else {
                        results.failed.push({
                            trackingNumber: trackingNumber,
                            result: value.message,
                            status: "Failed"
                        });
                        results.failedCount++;
                    }
                } else {
                    results.failed.push({
                        trackingNumber: trackingNumber,
                        result: 'Processing error',
                        status: "Error"
                    });
                    results.failedCount++;
                }
            });

            console.log(`📊 Batch results: ${results.updatedCount} updated, ${results.failedCount} failed, ${results.delayedCount} delayed, ${results.duplicateCount} duplicates`);
            return results;
        }

        function getUpdateTitle(updateCode) {
            const updateTitles = {
                'UAN': 'MAWB Number Update',
                'CCH': 'On Hold Update',
                'IIW': 'Item in Warehouse Update',
                'OFD': 'Out for Delivery Update',
                'OSC': 'Self Collect Update',
                'FCC': 'Customer Not Available Update',
                'FIA': 'Incorrect Address Update',
                'FSC': 'Reschedule to Self Collect Update',
                'SFJ': 'Clear Job Update',
                'OSD': 'Swap Dispatchers Update',
                'UWL': 'Update Warehouse',
                'UGR': 'Update Go Rush Remark',
                'UJD': 'Update Job Date',
                'UJM': 'Update Job Method',
                'UJP': 'Update Price',
                'UAW': 'Update Weight',
                'UAS': 'Update Address',
                'UAR': 'Update Area',
                'UPN': 'Update Phone Number',
                'URN': 'Update Customer Name',
                'UPC': 'Update Postal Code',
                'UAB': 'Update AWB Number',
                'UCD': 'Cancelled Job Update',
                'URJ': 'Reactivate Job Update',
                'UDJ': 'Dispose Job Update'
            };

            return updateTitles[updateCode] || 'Update Job';
        }

        function switchToActiveUpdateMode(updateCode, method) {
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('activeUpdateSection').style.display = 'block';

            const title = getUpdateTitle(updateCode);
            document.getElementById('activeUpdateTitle').textContent = title;

            if (method === 'bulk') {
                document.getElementById('bulkResults').style.display = 'none';
                document.getElementById('oneByOneInterface').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            } else if (method === 'onebyone') {
                document.getElementById('bulkResults').style.display = 'none';
                document.getElementById('oneByOneInterface').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('trackingNumSingle').focus();
                }, 300);
            }
        }

        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        });

        function resetToInitialMode() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            currentJobId = null;
            location.reload();
        }

        // Add a cancel job button (optional enhancement)
        function addCancelButton() {
            const resultsDiv = document.getElementById('bulkResults');
            if (resultsDiv && currentJobId) {
                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn btn-warning me-2';
                cancelButton.textContent = 'Cancel Job';
                cancelButton.onclick = async () => {
                    if (confirm('Are you sure you want to cancel this job?')) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        currentJobId = null;
                        document.getElementById('loading').style.display = 'none';
                        alert('Job cancelled');
                    }
                };

                const buttonContainer = resultsDiv.querySelector('.d-grid');
                if (buttonContainer) {
                    buttonContainer.prepend(cancelButton);
                }
            }
        }
    </script>
</body>

</html>